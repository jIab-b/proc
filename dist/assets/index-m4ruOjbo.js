(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const De=`struct Camera { viewProj : mat4x4<f32> }
@group(0) @binding(0) var<uniform> uCamera : Camera;

struct VSIn {
  @location(0) position : vec3<f32>,
  @location(1) normal : vec3<f32>,
  @location(2) color : vec3<f32>
}

struct VSOut {
  @builtin(position) position : vec4<f32>,
  @location(0) normal : vec3<f32>,
  @location(1) color : vec3<f32>
}

@vertex
fn vs_main(in_ : VSIn) -> VSOut {
  var out : VSOut;
  out.position = uCamera.viewProj * vec4<f32>(in_.position, 1.0);
  out.normal = normalize(in_.normal);
  out.color = in_.color;
  return out;
}

@fragment
fn fs_main(in_ : VSOut) -> @location(0) vec4<f32> {
  let sunDir = normalize(vec3<f32>(-0.4, -0.85, -0.5));
  let sunColor = vec3<f32>(1.0, 0.97, 0.9);
  let n = normalize(in_.normal);
  let sunDiffuse = max(dot(n, -sunDir), 0.0);
  let skyFactor = clamp(n.y * 0.5 + 0.5, 0.0, 1.0);
  let skyColor = vec3<f32>(0.53, 0.81, 0.92);
  let horizonColor = vec3<f32>(0.18, 0.16, 0.12);
  let ambient = (horizonColor * (1.0 - skyFactor) + skyColor * skyFactor) * 0.55;
  let diffuse = sunDiffuse * sunColor;
  let litColor = in_.color * (ambient + diffuse);
  return vec4<f32>(litColor, 1.0);
}
`;function ke(t,e,n,r){const o=1/Math.tan(t/2),s=1/(n-r),i=new Float32Array(16);return i[0]=o/e,i[5]=o,i[10]=(r+n)*s,i[11]=-1,i[14]=2*r*n*s,i}function Oe(t,e,n){const[r,o,s]=t,[i,f,p]=e;let m=r-i,g=o-f,v=s-p,d=Math.hypot(m,g,v);m/=d,g/=d,v/=d;let h=n[1]*v-n[2]*g,a=n[2]*m-n[0]*v,c=n[0]*g-n[1]*m;d=Math.hypot(h,a,c),h/=d,a/=d,c/=d;const w=g*c-v*a,b=v*h-m*c,M=m*a-g*h,l=new Float32Array(16);return l[0]=h,l[1]=w,l[2]=m,l[3]=0,l[4]=a,l[5]=b,l[6]=g,l[7]=0,l[8]=c,l[9]=M,l[10]=v,l[11]=0,l[12]=-(h*r+a*o+c*s),l[13]=-(w*r+b*o+M*s),l[14]=-(m*r+g*o+v*s),l[15]=1,l}function Be(t,e){const n=new Float32Array(16);for(let r=0;r<4;r++){const o=t[r],s=t[r+4],i=t[r+8],f=t[r+12];n[r]=o*e[0]+s*e[1]+i*e[2]+f*e[3],n[r+4]=o*e[4]+s*e[5]+i*e[6]+f*e[7],n[r+8]=o*e[8]+s*e[9]+i*e[10]+f*e[11],n[r+12]=o*e[12]+s*e[13]+i*e[14]+f*e[15]}return n}var x=(t=>(t[t.Air=0]="Air",t[t.Grass=1]="Grass",t[t.Dirt=2]="Dirt",t[t.Stone=3]="Stone",t[t.Plank=4]="Plank",t[t.Snow=5]="Snow",t[t.Sand=6]="Sand",t[t.Water=7]="Water",t))(x||{});const Ve={0:{normal:[1,0,0],offset:[1,0,0],corners:[[1,0,0],[1,1,0],[1,1,1],[1,0,1]],colorSlot:"side"},1:{normal:[-1,0,0],offset:[-1,0,0],corners:[[0,0,0],[0,0,1],[0,1,1],[0,1,0]],colorSlot:"side"},2:{normal:[0,1,0],offset:[0,1,0],corners:[[0,1,0],[0,1,1],[1,1,1],[1,1,0]],colorSlot:"top"},3:{normal:[0,-1,0],offset:[0,-1,0],corners:[[0,0,0],[1,0,0],[1,0,1],[0,0,1]],colorSlot:"bottom"},4:{normal:[0,0,1],offset:[0,0,1],corners:[[0,0,1],[1,0,1],[1,1,1],[0,1,1]],colorSlot:"side"},5:{normal:[0,0,-1],offset:[0,0,-1],corners:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],colorSlot:"side"}},Se=[0,1,2,0,2,3],Re={0:void 0,1:{top:[.34,.68,.36],bottom:[.4,.3,.16],side:[.45,.58,.3]},2:{top:[.42,.32,.2],bottom:[.38,.26,.16],side:[.4,.3,.18]},3:{top:[.58,.6,.64],bottom:[.55,.57,.6],side:[.56,.58,.62]},4:{top:[.78,.68,.5],bottom:[.72,.6,.42],side:[.74,.63,.45]},5:{top:[.92,.94,.96],bottom:[.9,.92,.94],side:[.88,.9,.93]},6:{top:[.88,.82,.6],bottom:[.86,.78,.56],side:[.87,.8,.58]},7:{top:[.22,.4,.66],bottom:[.2,.34,.6],side:[.2,.38,.64]}};class qe{size;blocks;constructor(e={x:32,y:32,z:32}){this.size=e,this.blocks=new Uint8Array(e.x*e.y*e.z)}getBlock(e,n,r){return this.inBounds(e,n,r)?this.blocks[this.index(e,n,r)]:0}setBlock(e,n,r,o){this.inBounds(e,n,r)&&(this.blocks[this.index(e,n,r)]=o)}snapshotBlocks(){return new Uint8Array(this.blocks)}generateDefaultTerrain(e=1){const{x:n,y:r,z:o}=this.size;for(let s=0;s<n;s++)for(let i=0;i<o;i++){const f=Math.min(r-1,Math.floor(6+this.sampleElevation(s,i,e)*(r-10)));for(let p=0;p<r;p++){if(p>f){this.setBlock(s,p,i,0);continue}p===f?this.setBlock(s,p,i,1):p>=f-2?this.setBlock(s,p,i,2):this.setBlock(s,p,i,3)}}}sampleElevation(e,n,r){const s=this.valueNoise(e*.08,n*.08,r),i=this.valueNoise(e*.08*2,n*.08*2,r+73)*.5,f=this.valueNoise(e*.08*4,n*.08*4,r+139)*.25;return(s+i+f)/(1+.5+.25)}valueNoise(e,n,r){const o=Math.floor(e),s=Math.floor(n),i=e-o,f=n-s,p=this.hash(o,s,r),m=this.hash(o+1,s,r),g=this.hash(o,s+1,r),v=this.hash(o+1,s+1,r),d=be(i),h=be(f),a=fe(p,m,d),c=fe(g,v,d);return fe(a,c,h)}hash(e,n,r){const o=Math.sin(e*157.31+n*311.7+r*93.13)*43758.5453;return o-Math.floor(o)}inBounds(e,n,r){return e>=0&&n>=0&&r>=0&&e<this.size.x&&n<this.size.y&&r<this.size.z}index(e,n,r){return e+this.size.x*(r+this.size.z*n)}}function Ge(t,e=1){const n=[],{x:r,y:o,z:s}=t.size,i=-r/2,f=-s/2;for(let g=0;g<o;g++)for(let v=0;v<s;v++)for(let d=0;d<r;d++){const h=t.getBlock(d,g,v);if(h===0)continue;const a=Re[h];for(let c=0;c<6;c++){const w=Ve[c],b=d+w.offset[0],M=g+w.offset[1],l=v+w.offset[2];if(t.getBlock(b,M,l)!==0)continue;const z=a[w.colorSlot],F=d+i,_=g,C=v+f;for(let S=0;S<Se.length;S++){const A=Se[S],D=w.corners[A];n.push((F+D[0])*e,(_+D[1])*e,(C+D[2])*e,w.normal[0],w.normal[1],w.normal[2],z[0],z[1],z[2])}}}const p=new Float32Array(n),m=p.length/9;return{vertexData:p,vertexCount:m}}function fe(t,e,n){return t*(1-n)+e*n}function be(t){return t*t*(3-2*t)}const Ue={very_low:.15,low:.35,medium:.5,high:.7,very_high:.9},Ye={low:.25,normal:.35,high:.45},We={small:1/128,medium:1/256,large:1/512,massive:1/1024},je=[1,2,4,8];function Y(t){return Ue[t]}function ze(t){return Ye[t]}function $e(t){return We[t]}function He(t=1337){return{seed:t,label:"temperate_basin",biome:"temperate",terrain:"valley",terrainProfile:{elevationVariance:"high",ridgeFrequency:"medium",warpStrength:"low",seaLevel:"normal",macroScale:"massive"},features:{riverCount:4,treeDensity:"high",caveDensity:"low"},shaders:["default_day"],seeds:Ke(t),dimensions:{x:256,y:96,z:256},unitsPerBlock:4}}function Ke(t){return{climate:X(t,"climate"),terrain:X(t,"terrain"),surface:X(t,"surface"),features:X(t,"features"),rivers:X(t,"rivers"),caves:X(t,"caves")}}function X(t,e){let n=t>>>0;for(let r=0;r<e.length;r++){const o=e.charCodeAt(r);n=Math.imul(n^o,73244475),n=(n^n>>>13)>>>0}return n=Math.imul(n^n>>>16,2654435761),n>>>0}class Xe{constructor(e,n){this.ctx=e,this.entry=n}closed=!1;add(e){Object.assign(this.entry.data,e)}end(e={}){this.closed||(this.closed=!0,this.add(e),this.entry.durationMs=performance.now()-this.entry.startedAt,this.ctx.commit(this.entry))}}class Ze{constructor(e){this.label=e}stages=[];begin(e,n,r={}){const o={stage:e,seed:n,startedAt:performance.now(),data:{...r}};return new Xe(this,o)}commit(e){this.stages.push(e)}serialize(){return{label:this.label,stages:this.stages.map(e=>({stage:e.stage,seed:e.seed,durationMs:e.durationMs,data:e.data}))}}get entries(){return this.stages}}function Qe(t){return new Ze(t)}class ae{constructor(e){this.seed=e,this.state=e>>>0,this.stats={count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,mean:0}}state;stats;next(){let e=this.state+=1831565813;e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61);const n=((e^e>>>14)>>>0)/4294967296;return this.accumulate(n),n}nextRange(e,n){return e+(n-e)*this.next()}nextInt(e){return Math.floor(this.next()*e)}accumulate(e){const{stats:n}=this;n.count+=1,n.min=Math.min(n.min,e),n.max=Math.max(n.max,e);const r=e-n.mean;n.mean+=r/n.count}snapshot(){return this.stats.count===0?{count:0,min:0,max:0,mean:0}:{...this.stats}}}function Je(t,e,n){const r=Math.floor(t),o=Math.floor(e),s=t-r,i=e-o,f=oe(r,o,n),p=oe(r+1,o,n),m=oe(r,o+1,n),g=oe(r+1,o+1,n),v=Ie(s),d=Ie(i),h=de(f,p,v),a=de(m,g,v);return de(h,a,d)}function se(t,e,n,r=4,o=2,s=.5){let i=1,f=1,p=0,m=0;for(let g=0;g<r;g++)p+=Je(t*i,e*i,n+g*131)*f,m+=f,i*=o,f*=s;return m>0?p/m:0}function de(t,e,n){return t*(1-n)+e*n}function Ie(t){return t*t*(3-2*t)}function oe(t,e,n){let r=n>>>0;return r^=Math.imul(668265261,t),r=(r^r>>>15)>>>0,r^=Math.imul(374761393,e),r=(r^r>>>13)>>>0,((r^r>>>16)>>>0)/4294967296}function et(t){const{chunk:e,spec:n}=t,r=t.trace;if(e.size.x!==n.dimensions.x||e.size.y!==n.dimensions.y||e.size.z!==n.dimensions.z)throw new Error("Chunk dimensions do not match WorldSpec.dimensions");const o=tt(e,n,r),s=nt(e,n,o,r),i=st(e,n,s,r);rt(e,n,s,i,r),it(e,n,r),ot(e,n,s,i,r)}function tt(t,e,n){const r=n?.begin("climate.sample",e.seeds.climate,{biome:e.biome,terrain:e.terrain}),{x:o,z:s}=t.size,i=new Float32Array(o*s),f=new Float32Array(o*s),p=new ae(e.seeds.climate^305441741),m=1/92,g=p.nextRange(-.1,.1),v=p.nextRange(-.05,.05);let d=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,a=0,c=Number.POSITIVE_INFINITY,w=Number.NEGATIVE_INFINITY,b=0;for(let M=0;M<s;M++)for(let l=0;l<o;l++){const z=l+o*M,F=(l+p.nextRange(-1e3,1e3))*m,_=(M+p.nextRange(-1e3,1e3))*m,C=he(se(F,_,e.seeds.climate,4,2,.55)+g),S=he(se(F,_,e.seeds.climate+911,4,2,.6)+v);i[z]=C,f[z]=S,d=Math.min(d,C),h=Math.max(h,C),a+=C,c=Math.min(c,S),w=Math.max(w,S),b+=S}return r?.end({stats:{temperature:ie(d,h,a/(o*s)),moisture:ie(c,w,b/(o*s))},rng:p.snapshot()}),{temperature:i,moisture:f}}function nt(t,e,n,r){const o=r?.begin("terrain.heightfield",e.seeds.terrain,{terrainProfile:e.terrainProfile}),{x:s,z:i}=t.size,f=new Float32Array(s*i),p=Y(e.terrainProfile.ridgeFrequency),m=Y(e.terrainProfile.elevationVariance),g=Y(e.terrainProfile.warpStrength),d=$e(e.terrainProfile.macroScale)*(.45+p),h=d*(.5+Y(e.terrainProfile.warpStrength)*.5);let a=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,w=0;for(let b=0;b<i;b++)for(let M=0;M<s;M++){const l=M+s*b,z=M*d,F=b*d,_=se(z,F,e.seeds.terrain+1e3,3,2.7,.5)*g,C=se(z+_,F+_,e.seeds.terrain,5,2,.52),S=he(C*(.4+m*.6));f[l]=S,a=Math.min(a,S),c=Math.max(c,S),w+=S}return o?.end({stats:ie(a,c,w/(s*i)),baseFrequency:d,warpFrequency:h}),f}function rt(t,e,n,r,o){const s=o?.begin("terrain.surface",e.seeds.surface,{biome:e.biome}),{x:i,y:f,z:p}=t.size,m=Math.floor(ze(e.terrainProfile.seaLevel)*f);let g=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY;const d={};for(let h=0;h<p;h++)for(let a=0;a<i;a++){const c=a+i*h,w=n[c]??0,b=Math.floor(w*(f-3))+1;g=Math.min(g,b),v=Math.max(v,b);const M=at(e.biome);for(let l=0;l<f;l++){let z=x.Air;r[c]&&l>=b-1&&l<=m?z=x.Water:l>b&&l<=m?z=M.seaFill:l===b?z=r[c]?x.Water:M.top:l<b&&l>=b-3?z=M.subsurface:l<b&&(z=M.underground),t.setBlock(a,l,h,z)}d[t.getBlock(a,b,h)]=(d[t.getBlock(a,b,h)]??0)+1}s?.end({columnHeights:ie(g,v,(g+v)/2),seaLevel:m,topDistribution:d})}function ot(t,e,n,r,o){const s=o?.begin("features.surface",e.seeds.features,{features:e.features}),{x:i,y:f,z:p}=t.size,m=new ae(e.seeds.features^2654435761),g=Y(e.features.treeDensity)*.5;let v=0;for(let d=0;d<p;d++)for(let h=0;h<i;h++){const a=h+i*d,c=n[a]??0,w=Math.floor(c*(f-3));if(w<=2||m.next()>g||r[a])continue;const b=t.getBlock(h,w,d);if(!ct(b))continue;const M=3+m.nextInt(2);for(let l=0;l<M&&w+1+l<f;l++)t.setBlock(h,w+1+l,d,x.Plank);v+=1}s?.end({treesPlaced:v,rng:m.snapshot()})}function st(t,e,n,r){const o=r?.begin("terrain.rivers",e.seeds.rivers,{requested:e.features.riverCount}),{x:s,y:i,z:f}=t.size,p=new Uint8Array(s*f),m=new ae(e.seeds.rivers^1374389535),g=Math.max(1,Math.round(s/80)),v=Math.min(e.features.riverCount,g),d=Math.max(1,Math.round(s/256*(1+Y(e.terrainProfile.warpStrength)))),h=ze(e.terrainProfile.seaLevel);let a=0;for(let c=0;c<v;c++){let w=m.nextInt(s);const b=m.next()>.5?1:-1;for(let M=0;M<f;M++){const l=b>0?M:f-1-M;for(let F=-d;F<=d;F++){const C=O(w+F,0,s-1)+s*l;p[C]||(a+=1),p[C]=1,n[C]=Math.min(n[C]??1,h)}const z=m.nextRange(-1,1);w=O(Math.round(w+z),1,s-2)}}return o?.end({riversCarved:v,width:d,carvedCells:a,rng:m.snapshot()}),p}function it(t,e,n){const r=n?.begin("terrain.caves",e.seeds.caves,{density:e.features.caveDensity}),{x:o,y:s,z:i}=t.size,f=new ae(e.seeds.caves^2135587861),p=o*i/4096,m=Math.max(1,Math.round(Y(e.features.caveDensity)*4*p));let g=0;for(let v=0;v<m;v++){const d=O(f.nextInt(o),2,o-3),h=O(f.nextInt(i),2,i-3),a=O(3+f.nextInt(Math.max(1,s-8)),3,s-5),c=2+f.nextRange(0,1+Y(e.features.caveDensity)*4),w=c*c,b=O(Math.floor(d-c),1,o-2),M=O(Math.ceil(d+c),1,o-2),l=O(Math.floor(h-c),1,i-2),z=O(Math.ceil(h+c),1,i-2),F=O(Math.floor(a-c),2,s-6),_=O(Math.ceil(a+c),2,s-6);for(let C=l;C<=z;C++)for(let S=b;S<=M;S++){const A=lt(t,S,C);for(let D=F;D<=Math.min(_,A-2);D++){const $=S-d,H=D-a,q=C-h;$*$+H*H+q*q>w||t.getBlock(S,D,C)!==x.Air&&(t.setBlock(S,D,C,x.Air),g+=1)}}}r?.end({attempts:m,carvedBlocks:g,rng:f.snapshot()})}function at(t){switch(t){case"temperate":return J(x.Grass,x.Dirt,x.Stone,x.Air);case"tundra":return J(x.Snow,x.Stone,x.Stone,x.Air);case"desert":return J(x.Sand,x.Sand,x.Stone,x.Sand);case"islands":return J(x.Grass,x.Dirt,x.Stone,x.Water);default:return J(x.Grass,x.Dirt,x.Stone,x.Air)}}function J(t,e,n,r){return{top:t,subsurface:e,underground:n,seaFill:r}}function ct(t){return t===x.Grass||t===x.Dirt||t===x.Sand||t===x.Snow}function ie(t,e,n){return{min:t,max:e,mean:n}}function he(t){return Math.max(0,Math.min(1,t))}function O(t,e,n){return Math.max(e,Math.min(n,t))}function lt(t,e,n){const{y:r}=t.size;for(let o=r-1;o>=0;o--)if(t.getBlock(e,o,n)!==x.Air&&t.getBlock(e,o,n)!==x.Water)return o;return 0}const Me={properties:{biome:{enum:["temperate","tundra","desert","islands"]},terrain:{enum:["plains","ridged","valley","mesa"]}}};function ut(t){const e=[];if(!ee(t))return{valid:!1,errors:["WorldSpec must be an object"]};const n=t;return Q(n.seed)||e.push("seed missing or not integer"),R(n.biome,Me.properties.biome.enum)||e.push("invalid biome"),R(n.terrain,Me.properties.terrain.enum)||e.push("invalid terrain"),ee(n.terrainProfile)?ft(n.terrainProfile,e):e.push("terrainProfile missing"),ee(n.features)?dt(n.features,e):e.push("features missing"),Array.isArray(n.shaders)||e.push("shaders must be array"),ee(n.seeds)?ht(n.seeds,e):e.push("seeds missing"),ee(n.dimensions)?pt(n.dimensions,e):e.push("dimensions missing"),R(n.unitsPerBlock,je)||e.push("unitsPerBlock invalid"),e.length?{valid:!1,errors:e}:{valid:!0,errors:[]}}function ft(t,e){R(t.elevationVariance,ne())||e.push("terrainProfile.elevationVariance invalid"),R(t.ridgeFrequency,ne())||e.push("terrainProfile.ridgeFrequency invalid"),R(t.warpStrength,ne())||e.push("terrainProfile.warpStrength invalid"),R(t.seaLevel,["low","normal","high"])||e.push("terrainProfile.seaLevel invalid"),R(t.macroScale,mt())||e.push("terrainProfile.macroScale invalid")}function dt(t,e){(!Q(t.riverCount)||t.riverCount<0)&&e.push("features.riverCount invalid"),R(t.treeDensity,ne())||e.push("features.treeDensity invalid"),R(t.caveDensity,ne())||e.push("features.caveDensity invalid")}function ht(t,e){const n=["climate","terrain","surface","features","rivers","caves"];for(const r of n)Q(t[r])||e.push(`seeds.${String(r)} invalid`)}function ne(){return["very_low","low","medium","high","very_high"]}function mt(){return["small","medium","large","massive"]}function ee(t){return typeof t=="object"&&t!==null}function Q(t){return typeof t=="number"&&Number.isInteger(t)}function R(t,e){return e.includes(t)}function pt(t,e){(!Q(t.x)||t.x<8)&&e.push("dimensions.x invalid"),(!Q(t.y)||t.y<16)&&e.push("dimensions.y invalid"),(!Q(t.z)||t.z<8)&&e.push("dimensions.z invalid")}function gt(t){const e=ut(t);if(!e.valid)throw new Error(`Invalid WorldSpec:
- ${e.errors.join(`
- `)}`)}const vt=document.getElementById("app"),ce=document.createElement("div");ce.className="canvas-shell";const L=document.createElement("canvas");L.style.width="100%";L.style.height="100%";ce.appendChild(L);vt.appendChild(ce);const Pe=[],pe={log:console.log,warn:console.warn,error:console.error};function j(t){Pe.push(`[${new Date().toISOString()}] ${t}`)}console.log=(...t)=>{pe.log.apply(console,t),j(t.map(String).join(" "))};console.warn=(...t)=>{pe.warn.apply(console,t),j("WARN "+t.map(String).join(" "))};console.error=(...t)=>{pe.error.apply(console,t),j("ERROR "+t.map(String).join(" "))};async function xt(){const t=Pe.join(`
`);if("showSaveFilePicker"in window)try{const s=await(await window.showSaveFilePicker({suggestedName:"webgpu-log.txt",types:[{accept:{"text/plain":[".txt"]}}]})).createWritable();await s.write(t),await s.close();return}catch{}const e=new Blob([t],{type:"text/plain"}),n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download="webgpu-log.txt",r.click(),URL.revokeObjectURL(n)}function yt(){const t=document.createElement("div");t.className="log-ui";const e=document.createElement("button");e.textContent="Download Log",e.onclick=()=>{j("Saving log via download"),xt()},t.appendChild(e),document.body.appendChild(t)}function me(t){console.error(t)}function te(t){const e=Math.hypot(t[0],t[1],t[2]);return e<1e-5?[0,0,0]:[t[0]/e,t[1]/e,t[2]/e]}function Ne(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function Z(t,e,n){t[0]+=e[0]*n,t[1]+=e[1]*n,t[2]+=e[2]*n}function wt(t,e){return Math.ceil(t/e)*e}async function St(){if(yt(),window.onerror=(u,N,P,I,E)=>{j(`window.onerror ${u} @${N}:${P}:${I} ${E?.stack||""}`)},window.addEventListener("unhandledrejection",u=>{j(`unhandledrejection ${String(u.reason)}`)}),!("gpu"in navigator))throw new Error("WebGPU not supported");const t=navigator.gpu,e=await t.requestAdapter();if(!e)throw new Error("No adapter");const n=await e.requestDevice();try{n.addEventListener&&n.addEventListener("uncapturederror",u=>{j(`device uncapturederror: ${u?.error?.message||u}`)})}catch{}const r=L.getContext("webgpu"),o=t.getPreferredCanvasFormat();r.configure({device:n,format:o,alphaMode:"opaque"});let s=n.createTexture({size:{width:L.width||1,height:L.height||1,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});function i(){const u=ce.getBoundingClientRect(),N=Math.max(1,Math.min(2,window.devicePixelRatio||1)),P=Math.max(1,Math.floor(u.width*N)),I=Math.max(1,Math.floor(u.height*N));P===L.width&&I===L.height||(L.width=P,L.height=I,r.configure({device:n,format:o,alphaMode:"opaque"}),s.destroy(),s=n.createTexture({size:{width:P,height:I,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}))}window.addEventListener("resize",i),i();const f=n.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),p=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]});n.pushErrorScope("validation");const m=n.createShaderModule({code:De}),g=await m.getCompilationInfo();if(g.messages?.length)for(const u of g.messages)me(`terrain.wgsl: ${u.lineNum}:${u.linePos} ${u.message}`);const v=n.createRenderPipeline({layout:n.createPipelineLayout({bindGroupLayouts:[p]}),vertex:{module:m,entryPoint:"vs_main",buffers:[{arrayStride:9*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32x3"}]}]},fragment:{module:m,entryPoint:"fs_main",targets:[{format:o}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}});await n.popErrorScope().catch(u=>me(`Render pipeline error: ${String(u)}`));const d=n.createBindGroup({layout:p,entries:[{binding:0,resource:{buffer:f}}]}),h=He(7331);gt(h);const a=new qe(h.dimensions),c=h.unitsPerBlock,w=Qe(h.label??"world");et({chunk:a,spec:h,trace:w}),window.worldGenTrace=w.serialize();const b=[-a.size.x*c/2,0,-a.size.z*c/2],M=x.Plank;let l=!0,z=null,F=0,_=0;function C(){const u=Ge(a,c);if(_=u.vertexCount,_===0)return;const N=wt(u.vertexData.byteLength,4);(!z||N>F)&&(z?.destroy?.(),z=n.createBuffer({size:N,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),F=N),n.queue.writeBuffer(z,0,u.vertexData.buffer,u.vertexData.byteOffset,u.vertexData.byteLength)}const S=new Set;window.addEventListener("keydown",u=>{u.repeat||S.add(u.code)}),window.addEventListener("keyup",u=>{S.delete(u.code)}),window.addEventListener("blur",()=>S.clear());const A=[0,a.size.y*c*.55,a.size.z*c*.45],D=[0,a.size.y*c*.35,0],$=te([D[0]-A[0],D[1]-A[1],D[2]-A[2]]);let H=Math.atan2($[0],$[2]),q=Math.asin($[1]),le=!1;L.addEventListener("click",()=>L.requestPointerLock()),L.addEventListener("contextmenu",u=>u.preventDefault()),document.addEventListener("pointerlockchange",()=>{le=document.pointerLockElement===L}),window.addEventListener("mousemove",u=>{if(!le)return;const N=.0025;H-=u.movementX*N,q-=u.movementY*N;const P=Math.PI/2-.05;q=Math.max(-P,Math.min(P,q))});const Ee=[0,1,0],Ce=Math.sqrt((a.size.x*c)**2+(a.size.y*c)**2+(a.size.z*c)**2);function ge(){return te([Math.cos(q)*Math.sin(H),Math.sin(q),Math.cos(q)*Math.cos(H)])}function Te(u){return[(u[0]-b[0])/c,u[1]/c,(u[2]-b[2])/c]}function ve([u,N,P]){return u>=0&&N>=0&&P>=0&&u<a.size.x&&N<a.size.y&&P<a.size.z}function Ae(u,N,P=Ce){const I=te(N);if(Math.abs(I[0])<1e-5&&Math.abs(I[1])<1e-5&&Math.abs(I[2])<1e-5)return null;const E=Te(u);let y=[Math.floor(E[0]),Math.floor(E[1]),Math.floor(E[2])],ue=[...y];const T=[I[0]>0?1:I[0]<0?-1:0,I[1]>0?1:I[1]<0?-1:0,I[2]>0?1:I[2]<0?-1:0],B=[I[0]/c,I[1]/c,I[2]/c],k=[T[0]!==0?Math.abs(1/B[0]):Number.POSITIVE_INFINITY,T[1]!==0?Math.abs(1/B[1]):Number.POSITIVE_INFINITY,T[2]!==0?Math.abs(1/B[2]):Number.POSITIVE_INFINITY];let G=T[0]>0?(y[0]+1-E[0])*k[0]:T[0]<0?(E[0]-y[0])*k[0]:Number.POSITIVE_INFINITY,V=T[1]>0?(y[1]+1-E[1])*k[1]:T[1]<0?(E[1]-y[1])*k[1]:Number.POSITIVE_INFINITY,K=T[2]>0?(y[2]+1-E[2])*k[2]:T[2]<0?(E[2]-y[2])*k[2]:Number.POSITIVE_INFINITY;Number.isFinite(G)||(G=Number.POSITIVE_INFINITY),Number.isFinite(V)||(V=Number.POSITIVE_INFINITY),Number.isFinite(K)||(K=Number.POSITIVE_INFINITY);let W=[0,0,0],re=0;for(let we=0;we<256&&!(re>P);we++){if(ve(y)&&a.getBlock(y[0],y[1],y[2])!==x.Air){const _e=Math.abs(W[0])+Math.abs(W[1])+Math.abs(W[2])>0?W:[-Math.sign(I[0]),-Math.sign(I[1]),-Math.sign(I[2])];return{block:[...y],previous:[...ue],normal:_e}}let U;if(G<=V&&G<=K?U=0:V<=K?U=1:U=2,U===0&&T[0]===0||U===1&&T[1]===0||U===2&&T[2]===0)return null;ue=[...y],U===0?(y=[y[0]+T[0],y[1],y[2]],re=G,G+=k[0],W=[-T[0],0,0]):U===1?(y=[y[0],y[1]+T[1],y[2]],re=V,V+=k[1],W=[0,-T[1],0]):(y=[y[0],y[1],y[2]+T[2]],re=K,K+=k[2],W=[0,0,-T[2]])}return null}function Fe(u){if(u.button!==0&&u.button!==2)return;u.preventDefault();const N=Ae(A,ge());if(N){if(u.button===0)a.getBlock(N.block[0],N.block[1],N.block[2])!==x.Air&&(a.setBlock(N.block[0],N.block[1],N.block[2],x.Air),l=!0);else if(u.button===2){const P=N.previous;ve(P)&&a.getBlock(P[0],P[1],P[2])===x.Air&&(a.setBlock(P[0],P[1],P[2],M),l=!0)}}}window.addEventListener("mousedown",Fe);function Le(u){const N=L.width/Math.max(1,L.height),P=ke(60*Math.PI/180,N,.1,500),I=ge();let E=Ne(I,Ee);Math.hypot(E[0],E[1],E[2])<1e-4&&(E=[1,0,0]),E=te(E);const y=te(Ne(E,I)),B=(S.has("ShiftLeft")||S.has("ShiftRight")?20:10)*c*u;S.has("KeyW")&&Z(A,I,B),S.has("KeyS")&&Z(A,I,-B),S.has("KeyA")&&Z(A,E,-B),S.has("KeyD")&&Z(A,E,B),(S.has("KeyE")||S.has("Space"))&&Z(A,y,B),(S.has("KeyQ")||S.has("ControlLeft"))&&Z(A,y,-B);const k=[A[0]+I[0],A[1]+I[1],A[2]+I[2]],G=Oe(A,k,y),V=Be(P,G);n.queue.writeBuffer(f,0,V.buffer,V.byteOffset,V.byteLength)}let xe=performance.now();function ye(){const u=performance.now(),N=Math.min(.1,(u-xe)/1e3);xe=u,Le(N),l&&(C(),l=!1);const P=n.createCommandEncoder(),I=r.getCurrentTexture().createView(),E=s.createView(),y=P.beginRenderPass({colorAttachments:[{view:I,clearValue:{r:.53,g:.81,b:.92,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:E,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});z&&_>0&&(y.setPipeline(v),y.setBindGroup(0,d),y.setVertexBuffer(0,z),y.draw(_,1,0,0)),y.end(),n.queue.submit([P.finish()]),requestAnimationFrame(ye)}requestAnimationFrame(ye)}St().catch(t=>me(`Startup error: ${String(t)}`));
