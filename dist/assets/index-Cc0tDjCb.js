(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const De=`struct Camera { viewProj : mat4x4<f32> }
@group(0) @binding(0) var<uniform> uCamera : Camera;

struct VSIn {
  @location(0) position : vec3<f32>,
  @location(1) normal : vec3<f32>,
  @location(2) color : vec3<f32>
}

struct VSOut {
  @builtin(position) position : vec4<f32>,
  @location(0) normal : vec3<f32>,
  @location(1) color : vec3<f32>
}

@vertex
fn vs_main(in_ : VSIn) -> VSOut {
  var out : VSOut;
  out.position = uCamera.viewProj * vec4<f32>(in_.position, 1.0);
  out.normal = normalize(in_.normal);
  out.color = in_.color;
  return out;
}

@fragment
fn fs_main(in_ : VSOut) -> @location(0) vec4<f32> {
  let sunDir = normalize(vec3<f32>(-0.4, -0.85, -0.5));
  let sunColor = vec3<f32>(1.0, 0.97, 0.9);
  let n = normalize(in_.normal);
  let sunDiffuse = max(dot(n, -sunDir), 0.0);
  let skyFactor = clamp(n.y * 0.5 + 0.5, 0.0, 1.0);
  let skyColor = vec3<f32>(0.53, 0.81, 0.92);
  let horizonColor = vec3<f32>(0.18, 0.16, 0.12);
  let ambient = (horizonColor * (1.0 - skyFactor) + skyColor * skyFactor) * 0.55;
  let diffuse = sunDiffuse * sunColor;
  let litColor = in_.color * (ambient + diffuse);
  return vec4<f32>(litColor, 1.0);
}
`;function Oe(t,e,n,o){const s=1/Math.tan(t/2),r=1/(n-o),i=new Float32Array(16);return i[0]=s/e,i[5]=s,i[10]=(o+n)*r,i[11]=-1,i[14]=2*o*n*r,i}function ke(t,e,n){const[o,s,r]=t,[i,a,d]=e;let f=o-i,p=s-a,x=r-d,m=Math.hypot(f,p,x);f/=m,p/=m,x/=m;let g=n[1]*x-n[2]*p,c=n[2]*f-n[0]*x,l=n[0]*p-n[1]*f;m=Math.hypot(g,c,l),g/=m,c/=m,l/=m;const I=p*l-x*c,v=x*g-f*l,M=f*c-p*g,u=new Float32Array(16);return u[0]=g,u[1]=I,u[2]=f,u[3]=0,u[4]=c,u[5]=v,u[6]=p,u[7]=0,u[8]=l,u[9]=M,u[10]=x,u[11]=0,u[12]=-(g*o+c*s+l*r),u[13]=-(I*o+v*s+M*r),u[14]=-(f*o+p*s+x*r),u[15]=1,u}function Ve(t,e){const n=new Float32Array(16);for(let o=0;o<4;o++){const s=t[o],r=t[o+4],i=t[o+8],a=t[o+12];n[o]=s*e[0]+r*e[1]+i*e[2]+a*e[3],n[o+4]=s*e[4]+r*e[5]+i*e[6]+a*e[7],n[o+8]=s*e[8]+r*e[9]+i*e[10]+a*e[11],n[o+12]=s*e[12]+r*e[13]+i*e[14]+a*e[15]}return n}var w=(t=>(t[t.Air=0]="Air",t[t.Grass=1]="Grass",t[t.Dirt=2]="Dirt",t[t.Stone=3]="Stone",t[t.Plank=4]="Plank",t[t.Snow=5]="Snow",t[t.Sand=6]="Sand",t[t.Water=7]="Water",t))(w||{});const Be={0:{normal:[1,0,0],offset:[1,0,0],corners:[[1,0,0],[1,1,0],[1,1,1],[1,0,1]],colorSlot:"side"},1:{normal:[-1,0,0],offset:[-1,0,0],corners:[[0,0,0],[0,0,1],[0,1,1],[0,1,0]],colorSlot:"side"},2:{normal:[0,1,0],offset:[0,1,0],corners:[[0,1,0],[0,1,1],[1,1,1],[1,1,0]],colorSlot:"top"},3:{normal:[0,-1,0],offset:[0,-1,0],corners:[[0,0,0],[1,0,0],[1,0,1],[0,0,1]],colorSlot:"bottom"},4:{normal:[0,0,1],offset:[0,0,1],corners:[[0,0,1],[1,0,1],[1,1,1],[0,1,1]],colorSlot:"side"},5:{normal:[0,0,-1],offset:[0,0,-1],corners:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],colorSlot:"side"}},Pe=[0,1,2,0,2,3],Re={0:void 0,1:{top:[.34,.68,.36],bottom:[.4,.3,.16],side:[.45,.58,.3]},2:{top:[.42,.32,.2],bottom:[.38,.26,.16],side:[.4,.3,.18]},3:{top:[.58,.6,.64],bottom:[.55,.57,.6],side:[.56,.58,.62]},4:{top:[.78,.68,.5],bottom:[.72,.6,.42],side:[.74,.63,.45]},5:{top:[.92,.94,.96],bottom:[.9,.92,.94],side:[.88,.9,.93]},6:{top:[.88,.82,.6],bottom:[.86,.78,.56],side:[.87,.8,.58]},7:{top:[.22,.4,.66],bottom:[.2,.34,.6],side:[.2,.38,.64]}};class Ge{size;blocks;constructor(e={x:32,y:32,z:32}){this.size=e,this.blocks=new Uint8Array(e.x*e.y*e.z)}getBlock(e,n,o){return this.inBounds(e,n,o)?this.blocks[this.index(e,n,o)]:0}setBlock(e,n,o,s){this.inBounds(e,n,o)&&(this.blocks[this.index(e,n,o)]=s)}snapshotBlocks(){return new Uint8Array(this.blocks)}generateDefaultTerrain(e=1){const{x:n,y:o,z:s}=this.size;for(let r=0;r<n;r++)for(let i=0;i<s;i++){const a=Math.min(o-1,Math.floor(6+this.sampleElevation(r,i,e)*(o-10)));for(let d=0;d<o;d++){if(d>a){this.setBlock(r,d,i,0);continue}d===a?this.setBlock(r,d,i,1):d>=a-2?this.setBlock(r,d,i,2):this.setBlock(r,d,i,3)}}}sampleElevation(e,n,o){const r=this.valueNoise(e*.08,n*.08,o),i=this.valueNoise(e*.08*2,n*.08*2,o+73)*.5,a=this.valueNoise(e*.08*4,n*.08*4,o+139)*.25;return(r+i+a)/(1+.5+.25)}valueNoise(e,n,o){const s=Math.floor(e),r=Math.floor(n),i=e-s,a=n-r,d=this.hash(s,r,o),f=this.hash(s+1,r,o),p=this.hash(s,r+1,o),x=this.hash(s+1,r+1,o),m=Ee(i),g=Ee(a),c=we(d,f,m),l=we(p,x,m);return we(c,l,g)}hash(e,n,o){const s=Math.sin(e*157.31+n*311.7+o*93.13)*43758.5453;return s-Math.floor(s)}inBounds(e,n,o){return e>=0&&n>=0&&o>=0&&e<this.size.x&&n<this.size.y&&o<this.size.z}index(e,n,o){return e+this.size.x*(o+this.size.z*n)}}function Ye(t,e=1){const n=[],{x:o,y:s,z:r}=t.size,i=-o/2,a=-r/2;for(let p=0;p<s;p++)for(let x=0;x<r;x++)for(let m=0;m<o;m++){const g=t.getBlock(m,p,x);if(g===0)continue;const c=Re[g];for(let l=0;l<6;l++){const I=Be[l],v=m+I.offset[0],M=p+I.offset[1],u=x+I.offset[2];if(t.getBlock(v,M,u)!==0)continue;const S=c[I.colorSlot],L=m+i,D=p,E=x+a;for(let y=0;y<Pe.length;y++){const C=Pe[y],O=I.corners[C];n.push((L+O[0])*e,(D+O[1])*e,(E+O[2])*e,I.normal[0],I.normal[1],I.normal[2],S[0],S[1],S[2])}}}const d=new Float32Array(n),f=d.length/9;return{vertexData:d,vertexCount:f}}function we(t,e,n){return t*(1-n)+e*n}function Ee(t){return t*t*(3-2*t)}const qe={very_low:.15,low:.35,medium:.5,high:.7,very_high:.9},Ue={low:.25,normal:.35,high:.45},We={small:1/128,medium:1/256,large:1/512,massive:1/1024},je={none:{iterations:0,radius:0,falloff:0},light:{iterations:2,radius:2,falloff:.2},medium:{iterations:3,radius:3,falloff:.35},strong:{iterations:4,radius:4,falloff:.45}},$e=[1,2,4,8];function $(t){return qe[t]}function Ce(t){return Ue[t]}function He(t){return We[t]}function Ke(t){return je[t]}function Xe(t=1337){return{seed:t,label:"temperate_basin",biome:"temperate",terrain:"valley",terrainProfile:{elevationVariance:"high",ridgeFrequency:"medium",warpStrength:"low",seaLevel:"normal",macroScale:"massive",smoothing:"medium"},features:{riverCount:4,treeDensity:"high",caveDensity:"low"},shaders:["default_day"],seeds:Ze(t),dimensions:{x:256,y:96,z:256},unitsPerBlock:4}}function Ze(t){return{climate:ne(t,"climate"),terrain:ne(t,"terrain"),surface:ne(t,"surface"),features:ne(t,"features"),rivers:ne(t,"rivers"),caves:ne(t,"caves")}}function ne(t,e){let n=t>>>0;for(let o=0;o<e.length;o++){const s=e.charCodeAt(o);n=Math.imul(n^s,73244475),n=(n^n>>>13)>>>0}return n=Math.imul(n^n>>>16,2654435761),n>>>0}class Qe{constructor(e,n){this.ctx=e,this.entry=n}closed=!1;add(e){Object.assign(this.entry.data,e)}end(e={}){this.closed||(this.closed=!0,this.add(e),this.entry.durationMs=performance.now()-this.entry.startedAt,this.ctx.commit(this.entry))}}class Je{constructor(e){this.label=e}stages=[];begin(e,n,o={}){const s={stage:e,seed:n,startedAt:performance.now(),data:{...o}};return new Qe(this,s)}commit(e){this.stages.push(e)}serialize(){return{label:this.label,stages:this.stages.map(e=>({stage:e.stage,seed:e.seed,durationMs:e.durationMs,data:e.data}))}}get entries(){return this.stages}}function et(t){return new Je(t)}class pe{constructor(e){this.seed=e,this.state=e>>>0,this.stats={count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,mean:0}}state;stats;next(){let e=this.state+=1831565813;e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61);const n=((e^e>>>14)>>>0)/4294967296;return this.accumulate(n),n}nextRange(e,n){return e+(n-e)*this.next()}nextInt(e){return Math.floor(this.next()*e)}accumulate(e){const{stats:n}=this;n.count+=1,n.min=Math.min(n.min,e),n.max=Math.max(n.max,e);const o=e-n.mean;n.mean+=o/n.count}snapshot(){return this.stats.count===0?{count:0,min:0,max:0,mean:0}:{...this.stats}}}function tt(t,e,n){const o=Math.floor(t),s=Math.floor(e),r=t-o,i=e-s,a=me(o,s,n),d=me(o+1,s,n),f=me(o,s+1,n),p=me(o+1,s+1,n),x=Te(r),m=Te(i),g=Ie(a,d,x),c=Ie(f,p,x);return Ie(g,c,m)}function de(t,e,n,o=4,s=2,r=.5){let i=1,a=1,d=0,f=0;for(let p=0;p<o;p++)d+=tt(t*i,e*i,n+p*131)*a,f+=a,i*=s,a*=r;return f>0?d/f:0}function Ie(t,e,n){return t*(1-n)+e*n}function Te(t){return t*t*(3-2*t)}function me(t,e,n){let o=n>>>0;return o^=Math.imul(668265261,t),o=(o^o>>>15)>>>0,o^=Math.imul(374761393,e),o=(o^o>>>13)>>>0,((o^o>>>16)>>>0)/4294967296}function nt(t){const{chunk:e,spec:n}=t,o=t.trace;if(e.size.x!==n.dimensions.x||e.size.y!==n.dimensions.y||e.size.z!==n.dimensions.z)throw new Error("Chunk dimensions do not match WorldSpec.dimensions");const s=ot(e,n,o),r=rt(e,n,s,o);st(e,n,r,o);const i=ut(e,n,r,o);ct(e,n,r,i,o),ft(e,n,o),lt(e,n,r,i,o)}function ot(t,e,n){const o=n?.begin("climate.sample",e.seeds.climate,{biome:e.biome,terrain:e.terrain}),{x:s,z:r}=t.size,i=new Float32Array(s*r),a=new Float32Array(s*r),d=new pe(e.seeds.climate^305441741),f=1/92,p=d.nextRange(-.1,.1),x=d.nextRange(-.05,.05);let m=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,c=0,l=Number.POSITIVE_INFINITY,I=Number.NEGATIVE_INFINITY,v=0;for(let M=0;M<r;M++)for(let u=0;u<s;u++){const S=u+s*M,L=(u+d.nextRange(-1e3,1e3))*f,D=(M+d.nextRange(-1e3,1e3))*f,E=he(de(L,D,e.seeds.climate,4,2,.55)+p),y=he(de(L,D,e.seeds.climate+911,4,2,.6)+x);i[S]=E,a[S]=y,m=Math.min(m,E),g=Math.max(g,E),c+=E,l=Math.min(l,y),I=Math.max(I,y),v+=y}return o?.end({stats:{temperature:X(m,g,c/(s*r)),moisture:X(l,I,v/(s*r))},rng:d.snapshot()}),{temperature:i,moisture:a}}function rt(t,e,n,o){const s=o?.begin("terrain.heightfield",e.seeds.terrain,{terrainProfile:e.terrainProfile}),{x:r,z:i}=t.size,a=new Float32Array(r*i),d=$(e.terrainProfile.ridgeFrequency),f=$(e.terrainProfile.elevationVariance),p=$(e.terrainProfile.warpStrength),m=He(e.terrainProfile.macroScale)*(.45+d),g=m*(.5+$(e.terrainProfile.warpStrength)*.5);let c=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,I=0;for(let v=0;v<i;v++)for(let M=0;M<r;M++){const u=M+r*v,S=M*m,L=v*m,D=de(S,L,e.seeds.terrain+1e3,3,2.7,.5)*p,E=de(S+D,L+D,e.seeds.terrain,5,2,.52),y=he(E*(.4+f*.6));a[u]=y,c=Math.min(c,y),l=Math.max(l,y),I+=y}return s?.end({stats:X(c,l,I/(r*i)),baseFrequency:m,warpFrequency:g}),a}function st(t,e,n,o){const{iterations:s,radius:r,falloff:i}=Ke(e.terrainProfile.smoothing),a=o?.begin("terrain.smooth",e.seeds.terrain^2779096485,{level:e.terrainProfile.smoothing,iterations:s,radius:r,falloff:i});if(s===0||r===0){a?.end({skipped:!0});return}const{x:d,z:f}=t.size,p=it(r,i),x=new Float32Array(n.length),m=d*f,g=[];let c=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,I=0;for(let N=0;N<n.length;N++){const T=n[N]??0;c=Math.min(c,T),l=Math.max(l,T),I+=T}a?.add({before:X(c,l,I/Math.max(1,m))});let v=n,M=x;const u=Math.min(.95,.55+i*.8);for(let N=0;N<s;N++){let T=0,V=0;for(let Q=0;Q<f;Q++)for(let H=0;H<d;H++){const le=H+d*Q,J=v[le]??0,ve=at(v,H,Q,d,f,p)-J,ue=J+ve*u;M[le]=ue;const ee=Math.abs(ue-J);T+=ee,ee>V&&(V=ee)}g.push({iteration:N+1,meanDelta:T/m,maxDelta:V});const xe=v;v=M,M=xe}if(v!==n)for(let N=0;N<n.length;N++)n[N]=v[N]??0;let S=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY,D=0;for(let N=0;N<n.length;N++){const T=n[N]??0;S=Math.min(S,T),L=Math.max(L,T),D+=T}let E=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,C=0;const O=L-S;if(O>1e-5){const N=1/O;for(let T=0;T<n.length;T++){const V=he(((n[T]??0)-S)*N);n[T]=V,E=Math.min(E,V),y=Math.max(y,V),C+=V}}else{for(let N=0;N<n.length;N++)n[N]=0;E=0,y=0,C=0}const U=X(E,y,C/Math.max(1,m));a?.end({kernelSize:p.length,blend:u,kernel:p.map(({dx:N,dz:T,normalizedWeight:V})=>({dx:N,dz:T,weight:Number(V.toFixed(4))})),iterationStats:g,rawStats:X(S,L,D/Math.max(1,m)),finalStats:U})}function it(t,e){const n=[];let o=0;for(let r=-t;r<=t;r++)for(let i=-t;i<=t;i++){const a=Math.hypot(i,r);if(a>t)continue;const d=1-e*a/Math.max(1,t),f=Math.max(.05,d);o+=f,n.push({dx:i,dz:r,weight:f,normalizedWeight:0})}const s=1/o;for(const r of n)r.normalizedWeight=r.weight*s;return n}function at(t,e,n,o,s,r){let i=0;for(const a of r){const d=B(e+a.dx,0,o-1),f=B(n+a.dz,0,s-1),p=d+o*f,x=t[p]??0;i+=x*a.normalizedWeight}return i}function ct(t,e,n,o,s){const r=s?.begin("terrain.surface",e.seeds.surface,{biome:e.biome}),{x:i,y:a,z:d}=t.size,f=Math.floor(Ce(e.terrainProfile.seaLevel)*a);let p=Number.POSITIVE_INFINITY,x=Number.NEGATIVE_INFINITY;const m={};for(let g=0;g<d;g++)for(let c=0;c<i;c++){const l=c+i*g,I=n[l]??0,v=Math.floor(I*(a-3))+1;p=Math.min(p,v),x=Math.max(x,v);const M=mt(e.biome);for(let u=0;u<a;u++){let S=w.Air;o[l]&&u>=v-1&&u<=f?S=w.Water:u>v&&u<=f?S=M.seaFill:u===v?S=o[l]?w.Water:M.top:u<v&&u>=v-3?S=M.subsurface:u<v&&(S=M.underground),t.setBlock(c,u,g,S)}m[t.getBlock(c,v,g)]=(m[t.getBlock(c,v,g)]??0)+1}r?.end({columnHeights:X(p,x,(p+x)/2),seaLevel:f,topDistribution:m})}function lt(t,e,n,o,s){const r=s?.begin("features.surface",e.seeds.features,{features:e.features}),{x:i,y:a,z:d}=t.size,f=new pe(e.seeds.features^2654435761),p=$(e.features.treeDensity)*.5;let x=0;for(let m=0;m<d;m++)for(let g=0;g<i;g++){const c=g+i*m,l=n[c]??0,I=Math.floor(l*(a-3));if(I<=2||f.next()>p||o[c])continue;const v=t.getBlock(g,I,m);if(!dt(v))continue;const M=3+f.nextInt(2);for(let u=0;u<M&&I+1+u<a;u++)t.setBlock(g,I+1+u,m,w.Plank);x+=1}r?.end({treesPlaced:x,rng:f.snapshot()})}function ut(t,e,n,o){const s=o?.begin("terrain.rivers",e.seeds.rivers,{requested:e.features.riverCount}),{x:r,y:i,z:a}=t.size,d=new Uint8Array(r*a),f=new pe(e.seeds.rivers^1374389535),p=Math.max(1,Math.round(r/80)),x=Math.min(e.features.riverCount,p),m=Math.max(1,Math.round(r/256*(1+$(e.terrainProfile.warpStrength)))),g=Ce(e.terrainProfile.seaLevel);let c=0;for(let l=0;l<x;l++){let I=f.nextInt(r);const v=f.next()>.5?1:-1;for(let M=0;M<a;M++){const u=v>0?M:a-1-M;for(let L=-m;L<=m;L++){const E=B(I+L,0,r-1)+r*u;d[E]||(c+=1),d[E]=1,n[E]=Math.min(n[E]??1,g)}const S=f.nextRange(-1,1);I=B(Math.round(I+S),1,r-2)}}return s?.end({riversCarved:x,width:m,carvedCells:c,rng:f.snapshot()}),d}function ft(t,e,n){const o=n?.begin("terrain.caves",e.seeds.caves,{density:e.features.caveDensity}),{x:s,y:r,z:i}=t.size,a=new pe(e.seeds.caves^2135587861),d=s*i/4096,f=Math.max(1,Math.round($(e.features.caveDensity)*4*d));let p=0;for(let x=0;x<f;x++){const m=B(a.nextInt(s),2,s-3),g=B(a.nextInt(i),2,i-3),c=B(3+a.nextInt(Math.max(1,r-8)),3,r-5),l=2+a.nextRange(0,1+$(e.features.caveDensity)*4),I=l*l,v=B(Math.floor(m-l),1,s-2),M=B(Math.ceil(m+l),1,s-2),u=B(Math.floor(g-l),1,i-2),S=B(Math.ceil(g+l),1,i-2),L=B(Math.floor(c-l),2,r-6),D=B(Math.ceil(c+l),2,r-6);for(let E=u;E<=S;E++)for(let y=v;y<=M;y++){const C=ht(t,y,E);for(let O=L;O<=Math.min(D,C-2);O++){const U=y-m,N=O-c,T=E-g;U*U+N*N+T*T>I||t.getBlock(y,O,E)!==w.Air&&(t.setBlock(y,O,E,w.Air),p+=1)}}}o?.end({attempts:f,carvedBlocks:p,rng:a.snapshot()})}function mt(t){switch(t){case"temperate":return se(w.Grass,w.Dirt,w.Stone,w.Air);case"tundra":return se(w.Snow,w.Stone,w.Stone,w.Air);case"desert":return se(w.Sand,w.Sand,w.Stone,w.Sand);case"islands":return se(w.Grass,w.Dirt,w.Stone,w.Water);default:return se(w.Grass,w.Dirt,w.Stone,w.Air)}}function se(t,e,n,o){return{top:t,subsurface:e,underground:n,seaFill:o}}function dt(t){return t===w.Grass||t===w.Dirt||t===w.Sand||t===w.Snow}function X(t,e,n){return{min:t,max:e,mean:n}}function he(t){return Math.max(0,Math.min(1,t))}function B(t,e,n){return Math.max(e,Math.min(n,t))}function ht(t,e,n){const{y:o}=t.size;for(let s=o-1;s>=0;s--)if(t.getBlock(e,s,n)!==w.Air&&t.getBlock(e,s,n)!==w.Water)return s;return 0}const Fe={properties:{biome:{enum:["temperate","tundra","desert","islands"]},terrain:{enum:["plains","ridged","valley","mesa"]}}};function pt(t){const e=[];if(!ie(t))return{valid:!1,errors:["WorldSpec must be an object"]};const n=t;return re(n.seed)||e.push("seed missing or not integer"),G(n.biome,Fe.properties.biome.enum)||e.push("invalid biome"),G(n.terrain,Fe.properties.terrain.enum)||e.push("invalid terrain"),ie(n.terrainProfile)?gt(n.terrainProfile,e):e.push("terrainProfile missing"),ie(n.features)?xt(n.features,e):e.push("features missing"),Array.isArray(n.shaders)||e.push("shaders must be array"),ie(n.seeds)?vt(n.seeds,e):e.push("seeds missing"),ie(n.dimensions)?It(n.dimensions,e):e.push("dimensions missing"),G(n.unitsPerBlock,$e)||e.push("unitsPerBlock invalid"),e.length?{valid:!1,errors:e}:{valid:!0,errors:[]}}function gt(t,e){G(t.elevationVariance,ce())||e.push("terrainProfile.elevationVariance invalid"),G(t.ridgeFrequency,ce())||e.push("terrainProfile.ridgeFrequency invalid"),G(t.warpStrength,ce())||e.push("terrainProfile.warpStrength invalid"),G(t.seaLevel,["low","normal","high"])||e.push("terrainProfile.seaLevel invalid"),G(t.macroScale,yt())||e.push("terrainProfile.macroScale invalid"),G(t.smoothing,wt())||e.push("terrainProfile.smoothing invalid")}function xt(t,e){(!re(t.riverCount)||t.riverCount<0)&&e.push("features.riverCount invalid"),G(t.treeDensity,ce())||e.push("features.treeDensity invalid"),G(t.caveDensity,ce())||e.push("features.caveDensity invalid")}function vt(t,e){const n=["climate","terrain","surface","features","rivers","caves"];for(const o of n)re(t[o])||e.push(`seeds.${String(o)} invalid`)}function ce(){return["very_low","low","medium","high","very_high"]}function yt(){return["small","medium","large","massive"]}function wt(){return["none","light","medium","strong"]}function ie(t){return typeof t=="object"&&t!==null}function re(t){return typeof t=="number"&&Number.isInteger(t)}function G(t,e){return e.includes(t)}function It(t,e){(!re(t.x)||t.x<8)&&e.push("dimensions.x invalid"),(!re(t.y)||t.y<16)&&e.push("dimensions.y invalid"),(!re(t.z)||t.z<8)&&e.push("dimensions.z invalid")}function bt(t){const e=pt(t);if(!e.valid)throw new Error(`Invalid WorldSpec:
- ${e.errors.join(`
- `)}`)}const Mt=document.getElementById("app"),ge=document.createElement("div");ge.className="canvas-shell";const k=document.createElement("canvas");k.style.width="100%";k.style.height="100%";ge.appendChild(k);Mt.appendChild(ge);const Le=[],Me={log:console.log,warn:console.warn,error:console.error};function Z(t){Le.push(`[${new Date().toISOString()}] ${t}`)}console.log=(...t)=>{Me.log.apply(console,t),Z(t.map(String).join(" "))};console.warn=(...t)=>{Me.warn.apply(console,t),Z("WARN "+t.map(String).join(" "))};console.error=(...t)=>{Me.error.apply(console,t),Z("ERROR "+t.map(String).join(" "))};async function St(){const t=Le.join(`
`);if("showSaveFilePicker"in window)try{const r=await(await window.showSaveFilePicker({suggestedName:"webgpu-log.txt",types:[{accept:{"text/plain":[".txt"]}}]})).createWritable();await r.write(t),await r.close();return}catch{}const e=new Blob([t],{type:"text/plain"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download="webgpu-log.txt",o.click(),URL.revokeObjectURL(n)}function Nt(){const t=document.createElement("div");t.className="log-ui";const e=document.createElement("button");e.textContent="Download Log",e.onclick=()=>{Z("Saving log via download"),St()},t.appendChild(e),document.body.appendChild(t)}function be(t){console.error(t)}function ae(t){const e=Math.hypot(t[0],t[1],t[2]);return e<1e-5?[0,0,0]:[t[0]/e,t[1]/e,t[2]/e]}function Ae(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function oe(t,e,n){t[0]+=e[0]*n,t[1]+=e[1]*n,t[2]+=e[2]*n}function zt(t,e){return Math.ceil(t/e)*e}async function Pt(){if(Nt(),window.onerror=(h,P,F,z,A)=>{Z(`window.onerror ${h} @${P}:${F}:${z} ${A?.stack||""}`)},window.addEventListener("unhandledrejection",h=>{Z(`unhandledrejection ${String(h.reason)}`)}),!("gpu"in navigator))throw new Error("WebGPU not supported");const t=navigator.gpu,e=await t.requestAdapter();if(!e)throw new Error("No adapter");const n=await e.requestDevice();try{n.addEventListener&&n.addEventListener("uncapturederror",h=>{Z(`device uncapturederror: ${h?.error?.message||h}`)})}catch{}const o=k.getContext("webgpu"),s=t.getPreferredCanvasFormat();o.configure({device:n,format:s,alphaMode:"opaque"});let r=n.createTexture({size:{width:k.width||1,height:k.height||1,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});function i(){const h=ge.getBoundingClientRect(),P=Math.max(1,Math.min(2,window.devicePixelRatio||1)),F=Math.max(1,Math.floor(h.width*P)),z=Math.max(1,Math.floor(h.height*P));F===k.width&&z===k.height||(k.width=F,k.height=z,o.configure({device:n,format:s,alphaMode:"opaque"}),r.destroy(),r=n.createTexture({size:{width:F,height:z,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}))}window.addEventListener("resize",i),i();const a=n.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),d=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]});n.pushErrorScope("validation");const f=n.createShaderModule({code:De}),p=await f.getCompilationInfo();if(p.messages?.length)for(const h of p.messages)be(`terrain.wgsl: ${h.lineNum}:${h.linePos} ${h.message}`);const x=n.createRenderPipeline({layout:n.createPipelineLayout({bindGroupLayouts:[d]}),vertex:{module:f,entryPoint:"vs_main",buffers:[{arrayStride:9*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32x3"}]}]},fragment:{module:f,entryPoint:"fs_main",targets:[{format:s}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}});await n.popErrorScope().catch(h=>be(`Render pipeline error: ${String(h)}`));const m=n.createBindGroup({layout:d,entries:[{binding:0,resource:{buffer:a}}]}),g=Xe(7331);bt(g);const c=new Ge(g.dimensions),l=g.unitsPerBlock,I=et(g.label??"world");nt({chunk:c,spec:g,trace:I}),window.worldGenTrace=I.serialize();const v=[-c.size.x*l/2,0,-c.size.z*l/2],M=w.Plank;let u=!0,S=null,L=0,D=0;function E(){const h=Ye(c,l);if(D=h.vertexCount,D===0)return;const P=zt(h.vertexData.byteLength,4);(!S||P>L)&&(S?.destroy?.(),S=n.createBuffer({size:P,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),L=P),n.queue.writeBuffer(S,0,h.vertexData.buffer,h.vertexData.byteOffset,h.vertexData.byteLength)}const y=new Set;window.addEventListener("keydown",h=>{h.repeat||y.add(h.code)}),window.addEventListener("keyup",h=>{y.delete(h.code)}),window.addEventListener("blur",()=>y.clear());const C=[0,c.size.y*l*.55,c.size.z*l*.45],O=[0,c.size.y*l*.35,0],U=ae([O[0]-C[0],O[1]-C[1],O[2]-C[2]]);let N=Math.atan2(U[0],U[2]),T=Math.asin(U[1]),V=!1;k.addEventListener("click",()=>k.requestPointerLock()),k.addEventListener("contextmenu",h=>h.preventDefault()),document.addEventListener("pointerlockchange",()=>{V=document.pointerLockElement===k}),window.addEventListener("mousemove",h=>{if(!V)return;const P=.0025;N-=h.movementX*P,T-=h.movementY*P;const F=Math.PI/2-.05;T=Math.max(-F,Math.min(F,T))});const xe=[0,1,0],Q=Math.sqrt((c.size.x*l)**2+(c.size.y*l)**2+(c.size.z*l)**2);function H(){return ae([Math.cos(T)*Math.sin(N),Math.sin(T),Math.cos(T)*Math.cos(N)])}function le(h){return[(h[0]-v[0])/l,h[1]/l,(h[2]-v[2])/l]}function J([h,P,F]){return h>=0&&P>=0&&F>=0&&h<c.size.x&&P<c.size.y&&F<c.size.z}function Se(h,P,F=Q){const z=ae(P);if(Math.abs(z[0])<1e-5&&Math.abs(z[1])<1e-5&&Math.abs(z[2])<1e-5)return null;const A=le(h);let b=[Math.floor(A[0]),Math.floor(A[1]),Math.floor(A[2])],ye=[...b];const _=[z[0]>0?1:z[0]<0?-1:0,z[1]>0?1:z[1]<0?-1:0,z[2]>0?1:z[2]<0?-1:0],Y=[z[0]/l,z[1]/l,z[2]/l],R=[_[0]!==0?Math.abs(1/Y[0]):Number.POSITIVE_INFINITY,_[1]!==0?Math.abs(1/Y[1]):Number.POSITIVE_INFINITY,_[2]!==0?Math.abs(1/Y[2]):Number.POSITIVE_INFINITY];let W=_[0]>0?(b[0]+1-A[0])*R[0]:_[0]<0?(A[0]-b[0])*R[0]:Number.POSITIVE_INFINITY,q=_[1]>0?(b[1]+1-A[1])*R[1]:_[1]<0?(A[1]-b[1])*R[1]:Number.POSITIVE_INFINITY,te=_[2]>0?(b[2]+1-A[2])*R[2]:_[2]<0?(A[2]-b[2])*R[2]:Number.POSITIVE_INFINITY;Number.isFinite(W)||(W=Number.POSITIVE_INFINITY),Number.isFinite(q)||(q=Number.POSITIVE_INFINITY),Number.isFinite(te)||(te=Number.POSITIVE_INFINITY);let K=[0,0,0],fe=0;for(let ze=0;ze<256&&!(fe>F);ze++){if(J(b)&&c.getBlock(b[0],b[1],b[2])!==w.Air){const _e=Math.abs(K[0])+Math.abs(K[1])+Math.abs(K[2])>0?K:[-Math.sign(z[0]),-Math.sign(z[1]),-Math.sign(z[2])];return{block:[...b],previous:[...ye],normal:_e}}let j;if(W<=q&&W<=te?j=0:q<=te?j=1:j=2,j===0&&_[0]===0||j===1&&_[1]===0||j===2&&_[2]===0)return null;ye=[...b],j===0?(b=[b[0]+_[0],b[1],b[2]],fe=W,W+=R[0],K=[-_[0],0,0]):j===1?(b=[b[0],b[1]+_[1],b[2]],fe=q,q+=R[1],K=[0,-_[1],0]):(b=[b[0],b[1],b[2]+_[2]],fe=te,te+=R[2],K=[0,0,-_[2]])}return null}function ve(h){if(h.button!==0&&h.button!==2)return;h.preventDefault();const P=Se(C,H());if(P){if(h.button===0)c.getBlock(P.block[0],P.block[1],P.block[2])!==w.Air&&(c.setBlock(P.block[0],P.block[1],P.block[2],w.Air),u=!0);else if(h.button===2){const F=P.previous;J(F)&&c.getBlock(F[0],F[1],F[2])===w.Air&&(c.setBlock(F[0],F[1],F[2],M),u=!0)}}}window.addEventListener("mousedown",ve);function ue(h){const P=k.width/Math.max(1,k.height),F=Oe(60*Math.PI/180,P,.1,500),z=H();let A=Ae(z,xe);Math.hypot(A[0],A[1],A[2])<1e-4&&(A=[1,0,0]),A=ae(A);const b=ae(Ae(A,z)),Y=(y.has("ShiftLeft")||y.has("ShiftRight")?20:10)*l*h;y.has("KeyW")&&oe(C,z,Y),y.has("KeyS")&&oe(C,z,-Y),y.has("KeyA")&&oe(C,A,-Y),y.has("KeyD")&&oe(C,A,Y),(y.has("KeyE")||y.has("Space"))&&oe(C,b,Y),(y.has("KeyQ")||y.has("ControlLeft"))&&oe(C,b,-Y);const R=[C[0]+z[0],C[1]+z[1],C[2]+z[2]],W=ke(C,R,b),q=Ve(F,W);n.queue.writeBuffer(a,0,q.buffer,q.byteOffset,q.byteLength)}let ee=performance.now();function Ne(){const h=performance.now(),P=Math.min(.1,(h-ee)/1e3);ee=h,ue(P),u&&(E(),u=!1);const F=n.createCommandEncoder(),z=o.getCurrentTexture().createView(),A=r.createView(),b=F.beginRenderPass({colorAttachments:[{view:z,clearValue:{r:.53,g:.81,b:.92,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:A,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});S&&D>0&&(b.setPipeline(x),b.setBindGroup(0,m),b.setVertexBuffer(0,S),b.draw(D,1,0,0)),b.end(),n.queue.submit([F.finish()]),requestAnimationFrame(Ne)}requestAnimationFrame(Ne)}Pt().catch(t=>be(`Startup error: ${String(t)}`));
