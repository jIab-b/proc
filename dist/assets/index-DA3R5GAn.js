(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=o(s);fetch(s.href,i)}})();const he=`struct Camera { viewProj : mat4x4<f32> }
@group(0) @binding(0) var<uniform> uCamera : Camera;

struct VSIn {
  @location(0) position : vec3<f32>,
  @location(1) normal : vec3<f32>,
  @location(2) color : vec3<f32>
}

struct VSOut {
  @builtin(position) position : vec4<f32>,
  @location(0) normal : vec3<f32>,
  @location(1) color : vec3<f32>
}

@vertex
fn vs_main(in_ : VSIn) -> VSOut {
  var out : VSOut;
  out.position = uCamera.viewProj * vec4<f32>(in_.position, 1.0);
  out.normal = normalize(in_.normal);
  out.color = in_.color;
  return out;
}

@fragment
fn fs_main(in_ : VSOut) -> @location(0) vec4<f32> {
  let lightDir = normalize(vec3<f32>(-0.4, -0.85, -0.5));
  let n = normalize(in_.normal);
  let lambert = max(dot(n, -lightDir), 0.0);
  let ambient = 0.25;
  let diffuse = lambert * 0.75;
  let litColor = in_.color * (ambient + diffuse);
  return vec4<f32>(litColor, 1.0);
}
`;function de(t,e,o,n){const s=1/Math.tan(t/2),i=1/(o-n),c=new Float32Array(16);return c[0]=s/e,c[5]=s,c[10]=(n+o)*i,c[11]=-1,c[14]=2*n*o*i,c}function me(t,e,o){const[n,s,i]=t,[c,g,b]=e;let w=n-c,v=s-g,x=i-b,S=Math.hypot(w,v,x);w/=S,v/=S,x/=S;let f=o[1]*x-o[2]*v,I=o[2]*w-o[0]*x,y=o[0]*v-o[1]*w;S=Math.hypot(f,I,y),f/=S,I/=S,y/=S;const k=v*y-x*I,P=x*f-w*y,B=w*I-v*f,d=new Float32Array(16);return d[0]=f,d[1]=k,d[2]=w,d[3]=0,d[4]=I,d[5]=P,d[6]=v,d[7]=0,d[8]=y,d[9]=B,d[10]=x,d[11]=0,d[12]=-(f*n+I*s+y*i),d[13]=-(k*n+P*s+B*i),d[14]=-(w*n+v*s+x*i),d[15]=1,d}function pe(t,e){const o=new Float32Array(16);for(let n=0;n<4;n++){const s=t[n],i=t[n+4],c=t[n+8],g=t[n+12];o[n]=s*e[0]+i*e[1]+c*e[2]+g*e[3],o[n+4]=s*e[4]+i*e[5]+c*e[6]+g*e[7],o[n+8]=s*e[8]+i*e[9]+c*e[10]+g*e[11],o[n+12]=s*e[12]+i*e[13]+c*e[14]+g*e[15]}return o}var U=(t=>(t[t.Air=0]="Air",t[t.Grass=1]="Grass",t[t.Dirt=2]="Dirt",t[t.Stone=3]="Stone",t[t.Plank=4]="Plank",t))(U||{});const ge={0:{normal:[1,0,0],offset:[1,0,0],corners:[[1,0,0],[1,1,0],[1,1,1],[1,0,1]],colorSlot:"side"},1:{normal:[-1,0,0],offset:[-1,0,0],corners:[[0,0,0],[0,0,1],[0,1,1],[0,1,0]],colorSlot:"side"},2:{normal:[0,1,0],offset:[0,1,0],corners:[[0,1,0],[0,1,1],[1,1,1],[1,1,0]],colorSlot:"top"},3:{normal:[0,-1,0],offset:[0,-1,0],corners:[[0,0,0],[1,0,0],[1,0,1],[0,0,1]],colorSlot:"bottom"},4:{normal:[0,0,1],offset:[0,0,1],corners:[[0,0,1],[1,0,1],[1,1,1],[0,1,1]],colorSlot:"side"},5:{normal:[0,0,-1],offset:[0,0,-1],corners:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],colorSlot:"side"}},te=[0,1,2,0,2,3],we={0:void 0,1:{top:[.34,.68,.36],bottom:[.4,.3,.16],side:[.45,.58,.3]},2:{top:[.42,.32,.2],bottom:[.38,.26,.16],side:[.4,.3,.18]},3:{top:[.58,.6,.64],bottom:[.55,.57,.6],side:[.56,.58,.62]},4:{top:[.78,.68,.5],bottom:[.72,.6,.42],side:[.74,.63,.45]}};class ve{size;blocks;constructor(e={x:32,y:32,z:32}){this.size=e,this.blocks=new Uint8Array(e.x*e.y*e.z)}getBlock(e,o,n){return this.inBounds(e,o,n)?this.blocks[this.index(e,o,n)]:0}setBlock(e,o,n,s){this.inBounds(e,o,n)&&(this.blocks[this.index(e,o,n)]=s)}generateDefaultTerrain(e=1){const{x:o,y:n,z:s}=this.size;for(let i=0;i<o;i++)for(let c=0;c<s;c++){const g=Math.min(n-1,Math.floor(6+this.sampleElevation(i,c,e)*(n-10)));for(let b=0;b<n;b++){if(b>g){this.setBlock(i,b,c,0);continue}b===g?this.setBlock(i,b,c,1):b>=g-2?this.setBlock(i,b,c,2):this.setBlock(i,b,c,3)}}}sampleElevation(e,o,n){const i=this.valueNoise(e*.08,o*.08,n),c=this.valueNoise(e*.08*2,o*.08*2,n+73)*.5,g=this.valueNoise(e*.08*4,o*.08*4,n+139)*.25;return(i+c+g)/(1+.5+.25)}valueNoise(e,o,n){const s=Math.floor(e),i=Math.floor(o),c=e-s,g=o-i,b=this.hash(s,i,n),w=this.hash(s+1,i,n),v=this.hash(s,i+1,n),x=this.hash(s+1,i+1,n),S=oe(c),f=oe(g),I=K(b,w,S),y=K(v,x,S);return K(I,y,f)}hash(e,o,n){const s=Math.sin(e*157.31+o*311.7+n*93.13)*43758.5453;return s-Math.floor(s)}inBounds(e,o,n){return e>=0&&o>=0&&n>=0&&e<this.size.x&&o<this.size.y&&n<this.size.z}index(e,o,n){return e+this.size.x*(n+this.size.z*o)}}function ye(t){const e=[],{x:o,y:n,z:s}=t.size,i=-o/2,c=-s/2;for(let w=0;w<n;w++)for(let v=0;v<s;v++)for(let x=0;x<o;x++){const S=t.getBlock(x,w,v);if(S===0)continue;const f=we[S];for(let I=0;I<6;I++){const y=ge[I],k=x+y.offset[0],P=w+y.offset[1],B=v+y.offset[2];if(t.getBlock(k,P,B)!==0)continue;const d=f[y.colorSlot],j=x+i,E=w,N=v+c;for(let A=0;A<te.length;A++){const O=te[A],F=y.corners[O];e.push(j+F[0],E+F[1],N+F[2],y.normal[0],y.normal[1],y.normal[2],d[0],d[1],d[2])}}}const g=new Float32Array(e),b=g.length/9;return{vertexData:g,vertexCount:b}}function K(t,e,o){return t*(1-o)+e*o}function oe(t){return t*t*(3-2*t)}const be=document.getElementById("app"),$=document.createElement("div");$.className="canvas-shell";const M=document.createElement("canvas");M.style.width="100%";M.style.height="100%";$.appendChild(M);be.appendChild($);const re=[],X={log:console.log,warn:console.warn,error:console.error};function D(t){re.push(`[${new Date().toISOString()}] ${t}`)}console.log=(...t)=>{X.log.apply(console,t),D(t.map(String).join(" "))};console.warn=(...t)=>{X.warn.apply(console,t),D("WARN "+t.map(String).join(" "))};console.error=(...t)=>{X.error.apply(console,t),D("ERROR "+t.map(String).join(" "))};async function xe(){const t=re.join(`
`);if("showSaveFilePicker"in window)try{const i=await(await window.showSaveFilePicker({suggestedName:"webgpu-log.txt",types:[{accept:{"text/plain":[".txt"]}}]})).createWritable();await i.write(t),await i.close();return}catch{}const e=new Blob([t],{type:"text/plain"}),o=URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download="webgpu-log.txt",n.click(),URL.revokeObjectURL(o)}function Me(){const t=document.createElement("div");t.className="log-ui";const e=document.createElement("button");e.textContent="Download Log",e.onclick=()=>{D("Saving log via download"),xe()},t.appendChild(e),document.body.appendChild(t)}function W(t){console.error(t)}function Y(t){const e=Math.hypot(t[0],t[1],t[2]);return e<1e-5?[0,0,0]:[t[0]/e,t[1]/e,t[2]/e]}function ne(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function R(t,e,o){t[0]+=e[0]*o,t[1]+=e[1]*o,t[2]+=e[2]*o}function Se(t,e){return Math.ceil(t/e)*e}async function Ie(){if(Me(),window.onerror=(r,u,h,l,p)=>{D(`window.onerror ${r} @${u}:${h}:${l} ${p?.stack||""}`)},window.addEventListener("unhandledrejection",r=>{D(`unhandledrejection ${String(r.reason)}`)}),!("gpu"in navigator))throw new Error("WebGPU not supported");const t=navigator.gpu,e=await t.requestAdapter();if(!e)throw new Error("No adapter");const o=await e.requestDevice();try{o.addEventListener&&o.addEventListener("uncapturederror",r=>{D(`device uncapturederror: ${r?.error?.message||r}`)})}catch{}const n=M.getContext("webgpu"),s=t.getPreferredCanvasFormat();n.configure({device:o,format:s,alphaMode:"opaque"});let i=o.createTexture({size:{width:M.width||1,height:M.height||1,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});function c(){const r=$.getBoundingClientRect(),u=Math.max(1,Math.min(2,window.devicePixelRatio||1)),h=Math.max(1,Math.floor(r.width*u)),l=Math.max(1,Math.floor(r.height*u));h===M.width&&l===M.height||(M.width=h,M.height=l,n.configure({device:o,format:s,alphaMode:"opaque"}),i.destroy(),i=o.createTexture({size:{width:h,height:l,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}))}window.addEventListener("resize",c),c();const g=o.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),b=o.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]});o.pushErrorScope("validation");const w=o.createShaderModule({code:he}),v=await w.getCompilationInfo();if(v.messages?.length)for(const r of v.messages)W(`terrain.wgsl: ${r.lineNum}:${r.linePos} ${r.message}`);const x=o.createRenderPipeline({layout:o.createPipelineLayout({bindGroupLayouts:[b]}),vertex:{module:w,entryPoint:"vs_main",buffers:[{arrayStride:9*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32x3"}]}]},fragment:{module:w,entryPoint:"fs_main",targets:[{format:s}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}});await o.popErrorScope().catch(r=>W(`Render pipeline error: ${String(r)}`));const S=o.createBindGroup({layout:b,entries:[{binding:0,resource:{buffer:g}}]}),f=new ve({x:36,y:28,z:36});f.generateDefaultTerrain(7);const I=[-f.size.x/2,0,-f.size.z/2],y=U.Plank;let k=!0,P=null,B=0,d=0;function j(){const r=ye(f);if(d=r.vertexCount,d===0)return;const u=Se(r.vertexData.byteLength,4);(!P||u>B)&&(P?.destroy?.(),P=o.createBuffer({size:u,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),B=u),o.queue.writeBuffer(P,0,r.vertexData.buffer,r.vertexData.byteOffset,r.vertexData.byteLength)}const E=new Set;window.addEventListener("keydown",r=>{r.repeat||E.add(r.code)}),window.addEventListener("keyup",r=>{E.delete(r.code)}),window.addEventListener("blur",()=>E.clear());const N=[0,f.size.y*.6,f.size.z*1.4];let A=-Math.PI/4,O=-.28,F=!1;M.addEventListener("click",()=>M.requestPointerLock()),M.addEventListener("contextmenu",r=>r.preventDefault()),document.addEventListener("pointerlockchange",()=>{F=document.pointerLockElement===M}),window.addEventListener("mousemove",r=>{if(!F)return;const u=.0025;A-=r.movementX*u,O-=r.movementY*u;const h=Math.PI/2-.05;O=Math.max(-h,Math.min(h,O))});const se=[0,1,0],ie=Math.sqrt(f.size.x**2+f.size.y**2+f.size.z**2);function Z(){return Y([Math.cos(O)*Math.sin(A),Math.sin(O),Math.cos(O)*Math.cos(A)])}function ae(r){return[r[0]-I[0],r[1],r[2]-I[2]]}function H([r,u,h]){return r>=0&&u>=0&&h>=0&&r<f.size.x&&u<f.size.y&&h<f.size.z}function ce(r,u,h=ie){const l=Y(u);if(Math.abs(l[0])<1e-5&&Math.abs(l[1])<1e-5&&Math.abs(l[2])<1e-5)return null;const p=ae(r);let a=[Math.floor(p[0]),Math.floor(p[1]),Math.floor(p[2])],q=[...a];const m=[l[0]>0?1:l[0]<0?-1:0,l[1]>0?1:l[1]<0?-1:0,l[2]>0?1:l[2]<0?-1:0],z=[m[0]!==0?Math.abs(1/l[0]):Number.POSITIVE_INFINITY,m[1]!==0?Math.abs(1/l[1]):Number.POSITIVE_INFINITY,m[2]!==0?Math.abs(1/l[2]):Number.POSITIVE_INFINITY];let C=m[0]>0?(a[0]+1-p[0])*z[0]:m[0]<0?(p[0]-a[0])*z[0]:Number.POSITIVE_INFINITY,L=m[1]>0?(a[1]+1-p[1])*z[1]:m[1]<0?(p[1]-a[1])*z[1]:Number.POSITIVE_INFINITY,_=m[2]>0?(a[2]+1-p[2])*z[2]:m[2]<0?(p[2]-a[2])*z[2]:Number.POSITIVE_INFINITY;Number.isFinite(C)||(C=Number.POSITIVE_INFINITY),Number.isFinite(L)||(L=Number.POSITIVE_INFINITY),Number.isFinite(_)||(_=Number.POSITIVE_INFINITY);let V=[0,0,0],G=0;for(let ee=0;ee<256&&!(G>h);ee++){if(H(a)&&f.getBlock(a[0],a[1],a[2])!==U.Air){const fe=Math.abs(V[0])+Math.abs(V[1])+Math.abs(V[2])>0?V:[-Math.sign(l[0]),-Math.sign(l[1]),-Math.sign(l[2])];return{block:[...a],previous:[...q],normal:fe}}let T;if(C<=L&&C<=_?T=0:L<=_?T=1:T=2,T===0&&m[0]===0||T===1&&m[1]===0||T===2&&m[2]===0)return null;q=[...a],T===0?(a=[a[0]+m[0],a[1],a[2]],G=C,C+=z[0],V=[-m[0],0,0]):T===1?(a=[a[0],a[1]+m[1],a[2]],G=L,L+=z[1],V=[0,-m[1],0]):(a=[a[0],a[1],a[2]+m[2]],G=_,_+=z[2],V=[0,0,-m[2]])}return null}function le(r){if(r.button!==0&&r.button!==2)return;r.preventDefault();const u=ce(N,Z());if(u){if(r.button===0)f.getBlock(u.block[0],u.block[1],u.block[2])!==U.Air&&(f.setBlock(u.block[0],u.block[1],u.block[2],U.Air),k=!0);else if(r.button===2){const h=u.previous;H(h)&&f.getBlock(h[0],h[1],h[2])===U.Air&&(f.setBlock(h[0],h[1],h[2],y),k=!0)}}}window.addEventListener("mousedown",le);function ue(r){const u=M.width/Math.max(1,M.height),h=de(60*Math.PI/180,u,.1,500),l=Z();let p=ne(l,se);Math.hypot(p[0],p[1],p[2])<1e-4&&(p=[1,0,0]),p=Y(p);const a=Y(ne(p,l)),m=(E.has("ShiftLeft")||E.has("ShiftRight")?20:10)*r;E.has("KeyW")&&R(N,l,m),E.has("KeyS")&&R(N,l,-m),E.has("KeyA")&&R(N,p,-m),E.has("KeyD")&&R(N,p,m),(E.has("KeyE")||E.has("Space"))&&R(N,a,m),(E.has("KeyQ")||E.has("ControlLeft"))&&R(N,a,-m);const z=[N[0]+l[0],N[1]+l[1],N[2]+l[2]],C=me(N,z,a),L=pe(h,C);o.queue.writeBuffer(g,0,L.buffer,L.byteOffset,L.byteLength)}let Q=performance.now();function J(){const r=performance.now(),u=Math.min(.1,(r-Q)/1e3);Q=r,ue(u),k&&(j(),k=!1);const h=o.createCommandEncoder(),l=n.getCurrentTexture().createView(),p=i.createView(),a=h.beginRenderPass({colorAttachments:[{view:l,clearValue:{r:.04,g:.05,b:.08,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:p,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});P&&d>0&&(a.setPipeline(x),a.setBindGroup(0,S),a.setVertexBuffer(0,P),a.draw(d,1,0,0)),a.end(),o.queue.submit([h.finish()]),requestAnimationFrame(J)}requestAnimationFrame(J)}Ie().catch(t=>W(`Startup error: ${String(t)}`));
