(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();const xe=`struct Camera { viewProj : mat4x4<f32> }
@group(0) @binding(0) var<uniform> uCamera : Camera;

struct VSIn {
  @location(0) position : vec3<f32>,
  @location(1) normal : vec3<f32>,
  @location(2) color : vec3<f32>
}

struct VSOut {
  @builtin(position) position : vec4<f32>,
  @location(0) normal : vec3<f32>,
  @location(1) color : vec3<f32>
}

@vertex
fn vs_main(in_ : VSIn) -> VSOut {
  var out : VSOut;
  out.position = uCamera.viewProj * vec4<f32>(in_.position, 1.0);
  out.normal = normalize(in_.normal);
  out.color = in_.color;
  return out;
}

@fragment
fn fs_main(in_ : VSOut) -> @location(0) vec4<f32> {
  let sunDir = normalize(vec3<f32>(-0.4, -0.85, -0.5));
  let sunColor = vec3<f32>(1.0, 0.97, 0.9);
  let n = normalize(in_.normal);
  let sunDiffuse = max(dot(n, -sunDir), 0.0);
  let skyFactor = clamp(n.y * 0.5 + 0.5, 0.0, 1.0);
  let skyColor = vec3<f32>(0.53, 0.81, 0.92);
  let horizonColor = vec3<f32>(0.18, 0.16, 0.12);
  let ambient = (horizonColor * (1.0 - skyFactor) + skyColor * skyFactor) * 0.55;
  let diffuse = sunDiffuse * sunColor;
  let litColor = in_.color * (ambient + diffuse);
  return vec4<f32>(litColor, 1.0);
}
`;function be(e,t,o,n){const r=1/Math.tan(e/2),s=1/(o-n),a=new Float32Array(16);return a[0]=r/t,a[5]=r,a[10]=(n+o)*s,a[11]=-1,a[14]=2*n*o*s,a}function Me(e,t,o){const[n,r,s]=e,[a,f,h]=t;let y=n-a,p=r-f,v=s-h,b=Math.hypot(y,p,v);y/=b,p/=b,v/=b;let S=o[1]*v-o[2]*p,l=o[2]*y-o[0]*v,c=o[0]*p-o[1]*y;b=Math.hypot(S,l,c),S/=b,l/=b,c/=b;const E=p*c-v*l,V=v*S-y*c,O=y*l-p*S,w=new Float32Array(16);return w[0]=S,w[1]=E,w[2]=y,w[3]=0,w[4]=l,w[5]=V,w[6]=p,w[7]=0,w[8]=c,w[9]=O,w[10]=v,w[11]=0,w[12]=-(S*n+l*r+c*s),w[13]=-(E*n+V*r+O*s),w[14]=-(y*n+p*r+v*s),w[15]=1,w}function Se(e,t){const o=new Float32Array(16);for(let n=0;n<4;n++){const r=e[n],s=e[n+4],a=e[n+8],f=e[n+12];o[n]=r*t[0]+s*t[1]+a*t[2]+f*t[3],o[n+4]=r*t[4]+s*t[5]+a*t[6]+f*t[7],o[n+8]=r*t[8]+s*t[9]+a*t[10]+f*t[11],o[n+12]=r*t[12]+s*t[13]+a*t[14]+f*t[15]}return o}var k=(e=>(e[e.Air=0]="Air",e[e.Grass=1]="Grass",e[e.Dirt=2]="Dirt",e[e.Stone=3]="Stone",e[e.Plank=4]="Plank",e[e.Snow=5]="Snow",e[e.Sand=6]="Sand",e[e.Water=7]="Water",e))(k||{});const Ie={0:{normal:[1,0,0],offset:[1,0,0],corners:[[1,0,0],[1,1,0],[1,1,1],[1,0,1]],colorSlot:"side"},1:{normal:[-1,0,0],offset:[-1,0,0],corners:[[0,0,0],[0,0,1],[0,1,1],[0,1,0]],colorSlot:"side"},2:{normal:[0,1,0],offset:[0,1,0],corners:[[0,1,0],[0,1,1],[1,1,1],[1,1,0]],colorSlot:"top"},3:{normal:[0,-1,0],offset:[0,-1,0],corners:[[0,0,0],[1,0,0],[1,0,1],[0,0,1]],colorSlot:"bottom"},4:{normal:[0,0,1],offset:[0,0,1],corners:[[0,0,1],[1,0,1],[1,1,1],[0,1,1]],colorSlot:"side"},5:{normal:[0,0,-1],offset:[0,0,-1],corners:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],colorSlot:"side"}},ce=[0,1,2,0,2,3],ze={0:void 0,1:{top:[.34,.68,.36],bottom:[.4,.3,.16],side:[.45,.58,.3]},2:{top:[.42,.32,.2],bottom:[.38,.26,.16],side:[.4,.3,.18]},3:{top:[.58,.6,.64],bottom:[.55,.57,.6],side:[.56,.58,.62]},4:{top:[.78,.68,.5],bottom:[.72,.6,.42],side:[.74,.63,.45]},5:{top:[.92,.94,.96],bottom:[.9,.92,.94],side:[.88,.9,.93]},6:{top:[.88,.82,.6],bottom:[.86,.78,.56],side:[.87,.8,.58]},7:{top:[.22,.4,.66],bottom:[.2,.34,.6],side:[.2,.38,.64]}};class Ne{size;blocks;constructor(t={x:32,y:32,z:32}){this.size=t,this.blocks=new Uint8Array(t.x*t.y*t.z)}getBlock(t,o,n){return this.inBounds(t,o,n)?this.blocks[this.index(t,o,n)]:0}setBlock(t,o,n,r){this.inBounds(t,o,n)&&(this.blocks[this.index(t,o,n)]=r)}snapshotBlocks(){return new Uint8Array(this.blocks)}generateDefaultTerrain(t=1){const{x:o,y:n,z:r}=this.size;for(let s=0;s<o;s++)for(let a=0;a<r;a++){const f=Math.min(n-1,Math.floor(6+this.sampleElevation(s,a,t)*(n-10)));for(let h=0;h<n;h++){if(h>f){this.setBlock(s,h,a,0);continue}h===f?this.setBlock(s,h,a,1):h>=f-2?this.setBlock(s,h,a,2):this.setBlock(s,h,a,3)}}}sampleElevation(t,o,n){const s=this.valueNoise(t*.08,o*.08,n),a=this.valueNoise(t*.08*2,o*.08*2,n+73)*.5,f=this.valueNoise(t*.08*4,o*.08*4,n+139)*.25;return(s+a+f)/(1+.5+.25)}valueNoise(t,o,n){const r=Math.floor(t),s=Math.floor(o),a=t-r,f=o-s,h=this.hash(r,s,n),y=this.hash(r+1,s,n),p=this.hash(r,s+1,n),v=this.hash(r+1,s+1,n),b=le(a),S=le(f),l=Q(h,y,b),c=Q(p,v,b);return Q(l,c,S)}hash(t,o,n){const r=Math.sin(t*157.31+o*311.7+n*93.13)*43758.5453;return r-Math.floor(r)}inBounds(t,o,n){return t>=0&&o>=0&&n>=0&&t<this.size.x&&o<this.size.y&&n<this.size.z}index(t,o,n){return t+this.size.x*(n+this.size.z*o)}}function Ee(e,t=1){const o=[],{x:n,y:r,z:s}=e.size,a=-n/2,f=-s/2;for(let p=0;p<r;p++)for(let v=0;v<s;v++)for(let b=0;b<n;b++){const S=e.getBlock(b,p,v);if(S===0)continue;const l=ze[S];for(let c=0;c<6;c++){const E=Ie[c],V=b+E.offset[0],O=p+E.offset[1],w=v+E.offset[2];if(e.getBlock(V,O,w)!==0)continue;const R=l[E.colorSlot],U=b+a,K=p,N=v+f;for(let I=0;I<ce.length;I++){const q=ce[I],B=E.corners[q];o.push((U+B[0])*t,(K+B[1])*t,(N+B[2])*t,E.normal[0],E.normal[1],E.normal[2],R[0],R[1],R[2])}}}const h=new Float32Array(o),y=h.length/9;return{vertexData:h,vertexCount:y}}function Q(e,t,o){return e*(1-o)+t*o}function le(e){return e*e*(3-2*e)}function Pe(e,t,o){const n=Math.floor(e),r=Math.floor(t),s=e-n,a=t-r,f=W(n,r,o),h=W(n+1,r,o),y=W(n,r+1,o),p=W(n+1,r+1,o),v=ue(s),b=ue(a),S=J(f,h,v),l=J(y,p,v);return J(S,l,b)}function Le(e,t,o,n=4,r=2,s=.5){let a=1,f=1,h=0,y=0;for(let p=0;p<n;p++)h+=Pe(e*a,t*a,o+p*131)*f,y+=f,a*=r,f*=s;return y>0?h/y:0}function J(e,t,o){return e*(1-o)+t*o}function ue(e){return e*e*(3-2*e)}function W(e,t,o){let n=o>>>0;return n^=Math.imul(668265261,e),n=(n^n>>>15)>>>0,n^=Math.imul(374761393,t),n=(n^n>>>13)>>>0,((n^n>>>16)>>>0)/4294967296}function Ce(e,t){const{x:o,y:n,z:r}=e.size;if(o!==t.dimensions.x||n!==t.dimensions.y||r!==t.dimensions.z)throw new Error("Chunk dimensions must match config dimensions");const s=t.seed,a=1/32;for(let f=0;f<o;f++)for(let h=0;h<r;h++){const p=(Le(f*a,h*a,s,4,2,.5)+1)/2,v=Math.floor(n*.2),S=Math.floor(n*.6)-v,l=Math.floor(v+p*S);for(let c=0;c<n;c++)c>l?e.setBlock(f,c,h,k.Air):c===l?e.setBlock(f,c,h,k.Grass):c>=l-3?e.setBlock(f,c,h,k.Dirt):e.setBlock(f,c,h,k.Stone)}}function ke(e=Date.now()){return{seed:e,dimensions:{x:128,y:64,z:128}}}const Oe=document.getElementById("app"),H=document.createElement("div");H.className="canvas-shell";const z=document.createElement("canvas");z.style.width="100%";z.style.height="100%";H.appendChild(z);Oe.appendChild(H);const he=[],te={log:console.log,warn:console.warn,error:console.error};function T(e){he.push(`[${new Date().toISOString()}] ${e}`)}console.log=(...e)=>{te.log.apply(console,e),T(e.map(String).join(" "))};console.warn=(...e)=>{te.warn.apply(console,e),T("WARN "+e.map(String).join(" "))};console.error=(...e)=>{te.error.apply(console,e),T("ERROR "+e.map(String).join(" "))};async function De(){const e=he.join(`
`);if("showSaveFilePicker"in window)try{const s=await(await window.showSaveFilePicker({suggestedName:"webgpu-log.txt",types:[{accept:{"text/plain":[".txt"]}}]})).createWritable();await s.write(e),await s.close();return}catch{}const t=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download="webgpu-log.txt",n.click(),URL.revokeObjectURL(o)}function Ae(){const e=document.createElement("div");e.className="log-ui";const t=document.createElement("button");t.textContent="Download Log",t.onclick=()=>{T("Saving log via download"),De()},e.appendChild(t),document.body.appendChild(e)}function ee(e){console.error(e)}function Y(e){const t=Math.hypot(e[0],e[1],e[2]);return t<1e-5?[0,0,0]:[e[0]/t,e[1]/t,e[2]/t]}function fe(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]}function $(e,t,o){e[0]+=t[0]*o,e[1]+=t[1]*o,e[2]+=t[2]*o}function Be(e,t){return Math.ceil(e/t)*t}async function Fe(){if(Ae(),window.onerror=(i,m,g,d,x)=>{T(`window.onerror ${i} @${m}:${g}:${d} ${x?.stack||""}`)},window.addEventListener("unhandledrejection",i=>{T(`unhandledrejection ${String(i.reason)}`)}),!("gpu"in navigator))throw new Error("WebGPU not supported");const e=navigator.gpu,t=await e.requestAdapter();if(!t)throw new Error("No adapter");const o=await t.requestDevice();try{o.addEventListener&&o.addEventListener("uncapturederror",i=>{T(`device uncapturederror: ${i?.error?.message||i}`)})}catch{}const n=z.getContext("webgpu"),r=e.getPreferredCanvasFormat();n.configure({device:o,format:r,alphaMode:"opaque"});let s=o.createTexture({size:{width:z.width||1,height:z.height||1,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});function a(){const i=H.getBoundingClientRect(),m=Math.max(1,Math.min(2,window.devicePixelRatio||1)),g=Math.max(1,Math.floor(i.width*m)),d=Math.max(1,Math.floor(i.height*m));g===z.width&&d===z.height||(z.width=g,z.height=d,n.configure({device:o,format:r,alphaMode:"opaque"}),s.destroy(),s=o.createTexture({size:{width:g,height:d,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}))}window.addEventListener("resize",a),a();const f=o.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),h=o.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]});o.pushErrorScope("validation");const y=o.createShaderModule({code:xe}),p=await y.getCompilationInfo();if(p.messages?.length)for(const i of p.messages)ee(`terrain.wgsl: ${i.lineNum}:${i.linePos} ${i.message}`);const v=o.createRenderPipeline({layout:o.createPipelineLayout({bindGroupLayouts:[h]}),vertex:{module:y,entryPoint:"vs_main",buffers:[{arrayStride:9*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32x3"}]}]},fragment:{module:y,entryPoint:"fs_main",targets:[{format:r}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}});await o.popErrorScope().catch(i=>ee(`Render pipeline error: ${String(i)}`));const b=o.createBindGroup({layout:h,entries:[{binding:0,resource:{buffer:f}}]}),S=ke(Math.floor(Math.random()*1e6)),l=new Ne(S.dimensions),c=2;console.log("Generating rolling hills terrain..."),Ce(l,S),console.log("Terrain generation complete");const E=[-l.size.x*c/2,0,-l.size.z*c/2],V=k.Plank;let O=!0,w=null,R=0,U=0;function K(){const i=Ee(l,c);if(U=i.vertexCount,U===0)return;const m=Be(i.vertexData.byteLength,4);(!w||m>R)&&(w?.destroy?.(),w=o.createBuffer({size:m,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),R=m),o.queue.writeBuffer(w,0,i.vertexData.buffer,i.vertexData.byteOffset,i.vertexData.byteLength)}const N=new Set;window.addEventListener("keydown",i=>{i.repeat||N.add(i.code)}),window.addEventListener("keyup",i=>{N.delete(i.code)}),window.addEventListener("blur",()=>N.clear());const I=[0,l.size.y*c*.55,l.size.z*c*.45],q=[0,l.size.y*c*.35,0],B=Y([q[0]-I[0],q[1]-I[1],q[2]-I[2]]);let X=Math.atan2(B[0],B[2]),_=Math.asin(B[1]),oe=!1;z.addEventListener("click",()=>z.requestPointerLock()),z.addEventListener("contextmenu",i=>i.preventDefault()),document.addEventListener("pointerlockchange",()=>{oe=document.pointerLockElement===z}),window.addEventListener("mousemove",i=>{if(!oe)return;const m=.0025;X-=i.movementX*m,_-=i.movementY*m;const g=Math.PI/2-.05;_=Math.max(-g,Math.min(g,_))});const de=[0,1,0],me=Math.sqrt((l.size.x*c)**2+(l.size.y*c)**2+(l.size.z*c)**2);function ne(){return Y([Math.cos(_)*Math.sin(X),Math.sin(_),Math.cos(_)*Math.cos(X)])}function pe(i){return[(i[0]-E[0])/c,i[1]/c,(i[2]-E[2])/c]}function re([i,m,g]){return i>=0&&m>=0&&g>=0&&i<l.size.x&&m<l.size.y&&g<l.size.z}function ge(i,m,g=me){const d=Y(m);if(Math.abs(d[0])<1e-5&&Math.abs(d[1])<1e-5&&Math.abs(d[2])<1e-5)return null;const x=pe(i);let u=[Math.floor(x[0]),Math.floor(x[1]),Math.floor(x[2])],Z=[...u];const M=[d[0]>0?1:d[0]<0?-1:0,d[1]>0?1:d[1]<0?-1:0,d[2]>0?1:d[2]<0?-1:0],L=[d[0]/c,d[1]/c,d[2]/c],P=[M[0]!==0?Math.abs(1/L[0]):Number.POSITIVE_INFINITY,M[1]!==0?Math.abs(1/L[1]):Number.POSITIVE_INFINITY,M[2]!==0?Math.abs(1/L[2]):Number.POSITIVE_INFINITY];let D=M[0]>0?(u[0]+1-x[0])*P[0]:M[0]<0?(x[0]-u[0])*P[0]:Number.POSITIVE_INFINITY,C=M[1]>0?(u[1]+1-x[1])*P[1]:M[1]<0?(x[1]-u[1])*P[1]:Number.POSITIVE_INFINITY,G=M[2]>0?(u[2]+1-x[2])*P[2]:M[2]<0?(x[2]-u[2])*P[2]:Number.POSITIVE_INFINITY;Number.isFinite(D)||(D=Number.POSITIVE_INFINITY),Number.isFinite(C)||(C=Number.POSITIVE_INFINITY),Number.isFinite(G)||(G=Number.POSITIVE_INFINITY);let F=[0,0,0],j=0;for(let ae=0;ae<256&&!(j>g);ae++){if(re(u)&&l.getBlock(u[0],u[1],u[2])!==k.Air){const ye=Math.abs(F[0])+Math.abs(F[1])+Math.abs(F[2])>0?F:[-Math.sign(d[0]),-Math.sign(d[1]),-Math.sign(d[2])];return{block:[...u],previous:[...Z],normal:ye}}let A;if(D<=C&&D<=G?A=0:C<=G?A=1:A=2,A===0&&M[0]===0||A===1&&M[1]===0||A===2&&M[2]===0)return null;Z=[...u],A===0?(u=[u[0]+M[0],u[1],u[2]],j=D,D+=P[0],F=[-M[0],0,0]):A===1?(u=[u[0],u[1]+M[1],u[2]],j=C,C+=P[1],F=[0,-M[1],0]):(u=[u[0],u[1],u[2]+M[2]],j=G,G+=P[2],F=[0,0,-M[2]])}return null}function we(i){if(i.button!==0&&i.button!==2)return;i.preventDefault();const m=ge(I,ne());if(m){if(i.button===0)l.getBlock(m.block[0],m.block[1],m.block[2])!==k.Air&&(l.setBlock(m.block[0],m.block[1],m.block[2],k.Air),O=!0);else if(i.button===2){const g=m.previous;re(g)&&l.getBlock(g[0],g[1],g[2])===k.Air&&(l.setBlock(g[0],g[1],g[2],V),O=!0)}}}window.addEventListener("mousedown",we);function ve(i){const m=z.width/Math.max(1,z.height),g=be(60*Math.PI/180,m,.1,500),d=ne();let x=fe(d,de);Math.hypot(x[0],x[1],x[2])<1e-4&&(x=[1,0,0]),x=Y(x);const u=Y(fe(x,d)),L=(N.has("ShiftLeft")||N.has("ShiftRight")?20:10)*c*i;N.has("KeyW")&&$(I,d,L),N.has("KeyS")&&$(I,d,-L),N.has("KeyA")&&$(I,x,-L),N.has("KeyD")&&$(I,x,L),(N.has("KeyE")||N.has("Space"))&&$(I,u,L),(N.has("KeyQ")||N.has("ControlLeft"))&&$(I,u,-L);const P=[I[0]+d[0],I[1]+d[1],I[2]+d[2]],D=Me(I,P,u),C=Se(g,D);o.queue.writeBuffer(f,0,C.buffer,C.byteOffset,C.byteLength)}let se=performance.now();function ie(){const i=performance.now(),m=Math.min(.1,(i-se)/1e3);se=i,ve(m),O&&(K(),O=!1);const g=o.createCommandEncoder(),d=n.getCurrentTexture().createView(),x=s.createView(),u=g.beginRenderPass({colorAttachments:[{view:d,clearValue:{r:.53,g:.81,b:.92,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:x,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});w&&U>0&&(u.setPipeline(v),u.setBindGroup(0,b),u.setVertexBuffer(0,w),u.draw(U,1,0,0)),u.end(),o.queue.submit([g.finish()]),requestAnimationFrame(ie)}requestAnimationFrame(ie)}Fe().catch(e=>ee(`Startup error: ${String(e)}`));
